USE master
GO
CREATE DATABASE dbQuanLyQuanCafeN10
GO
USE dbQuanLyQuanCafeN10
GO
CREATE TABLE NHANVIEN
(
	MANHANVIEN VARCHAR(10) NOT NULL,
	HOTEN NVARCHAR(50) NOT NULL,
	GIOITINH NVARCHAR(3),
	NGAYSINH DATE,
	DIACHI NVARCHAR(250),
	SDT VARCHAR(12),
	NGAYVAOLAM DATE,
	LUONGCOBAN INT,
	CHUCVU NVARCHAR(20) NOT NULL,
	HINHANH NVARCHAR(MAX),
	TINHTRANG INT DEFAULT 0,
	PRIMARY KEY (MANHANVIEN),
)
create table BANGLUONG
(
	MABANGLUONG VARCHAR(10) not null primary key,
	TENBANGLUONG nvarchar(50)
)
create table LUONGNV
(
	MABANGLUONG VARCHAR(10) not null,
	MANHANVIEN VARCHAR(10) not null,
	NGAYPHATLUONG date,
	LUONG float default 0,
	primary key(MABANGLUONG,MANHANVIEN)
)

create table LUONGQL
(
	MABANGLUONG VARCHAR(10) not null,
	MANHANVIEN VARCHAR(10) not null,
	NGAYPHATLUONG date,
	LUONG float default 0,
	primary key(MABANGLUONG,MANHANVIEN)
)

create table CALAM
(
	MACA VARCHAR(10) NOT NULL,
	CHITIETCA NVARCHAR(MAX),
	PRIMARY KEY(MACA)
)
create table CTBANGLUONGNV
(
	MABANGLUONG VARCHAR(10) not null,
	MANHANVIEN VARCHAR(10) not null,
	MACA VARCHAR(10) NOT NULL,
	NGAYLAM date,
	SOTIEN float,
	SOTIENG float,
	THANHTIEN float,
	GHICHU NVARCHAR(MAX)
	primary key(MABANGLUONG, MANHANVIEN,MACA,NGAYLAM)
)

create table CHAMCONG_LUONGQL
(
	MACHAMCONG VARCHAR (10) NOT NULL,
	TENBANGCHAMCONG NVARCHAR(MAX),
	GHICHU NVARCHAR(MAX)
	PRIMARY KEY (MACHAMCONG)
)

create table CTBANGLUONGQL
(
	MABANGLUONG VARCHAR(10) not null,
	MANHANVIEN VARCHAR(10) not null,
	MACA VARCHAR(10) NOT NULL,
	LUONGCOBAN float,
	NGAYCONGTHANG float,
	NGAYCONGTHUCTE float,
	HESOLUONG float,
	PHUCAP float,
	THANHTIEN float,
	GHICHU NVARCHAR(MAX)
	primary key(MABANGLUONG, MANHANVIEN, MACA)
)
CREATE TABLE CTCHAMCONG_QUANLY
(
	MACHAMCONG VARCHAR(10) NOT NULL,
	MABANGLUONG VARCHAR(10) not null,
	MANHANVIEN VARCHAR(10) not null,
	MACA VARCHAR(10) NOT NULL,
	NGAYLAM DATE,
	GHICHU NVARCHAR(MAX)
	PRIMARY KEY(MACHAMCONG,MABANGLUONG,MANHANVIEN,MACA,NGAYLAM)
)
CREATE TABLE NGUOIDUNG
(
	TENDANGNHAP VARCHAR(50) NOT NULL,
	MATKHAU VARCHAR(50),
	TRANGTHAI NVARCHAR(20),
	MANHANVIEN VARCHAR(10) NOT NULL,
	PRIMARY KEY(TENDANGNHAP)
)
CREATE TABLE NHOMNGUOIDUNG
(
	MANHOM VARCHAR(20) NOT NULL,
	TENNHOM NVARCHAR (50),
	GHICHU NVARCHAR(200),
	PRIMARY KEY(MANHOM)
)
CREATE TABLE NGUOIDUNGNHOMNGUOIDUNG
(
	TENDANGNHAP VARCHAR(50) NOT NULL,
	MANHOM VARCHAR(20) NOT NULL,
	GHICHU NVARCHAR(200),
	PRIMARY KEY(TENDANGNHAP,  MANHOM)
)
CREATE TABLE MANHINH
(
	MAMANHINH VARCHAR(20) NOT NULL,
	TENMANHINH NVARCHAR (50) NOT NULL,	
	PRIMARY KEY(MAMANHINH)
)

CREATE TABLE PHANQUYEN
(
	MANHOM VARCHAR(20) NOT NULL,
	MAMANHINH VARCHAR(20) NOT NULL,
	COQUYEN bit NOT NULL,
	PRIMARY KEY(MANHOM, MAMANHINH)
)
CREATE TABLE KHUVUC
(
	MAKHUVUC VARCHAR(10) NOT NULL,
	TENKHUVUC NVARCHAR(50) NOT NULL,
	TINHTRANG INT DEFAULT 0, -- 0: hoạt động, -1: đã xóa
	PRIMARY KEY(MAKHUVUC)
)
CREATE TABLE BAN
(
	MABAN INT IDENTITY NOT NULL,
	TENBAN NVARCHAR(50),
	SOCHONGOI INT,
	TRANGTHAI NVARCHAR(MAX),
	MAKHUVUC VARCHAR(10) NOT NULL,
	TINHTRANG INT DEFAULT 0, -- 0: hoạt động, -1: đã xóa
	PRIMARY KEY(MABAN) 
)

CREATE TABLE LOAIMON
(
	MALOAI VARCHAR(10) NOT NULL,
	TENLOAI NVARCHAR(255) UNIQUE,
	PRIMARY KEY(MALOAI)
)
CREATE TABLE THUCDON
(
	MAMON VARCHAR(10) NOT NULL,
	TENMON NVARCHAR(255) UNIQUE,
	MALOAI VARCHAR(10) NOT NULL,
	DVT NVARCHAR(10),
	HINHANH NVARCHAR(max),
	PRIMARY KEY(MAMON)
)

CREATE TABLE CTTHUCDON
(
	MACTMON VARCHAR(10) NOT NULL,
	Size VARCHAR(2) NOT NULL,
	GIA FLOAT,
	MAMON VARCHAR(10) NOT NULL,
	PRIMARY KEY(MACTMON)
)
CREATE TABLE GIAMGIA
(
	MAGIAMGIA VARCHAR(10) NOT NULL,
	GIAM INT,
	GIAMTOIDA INT,
	NGAYBATDAU DATE,
	NGAYKETTHUC DATE,
	SOLUOT INT,
	TINHTRANG INT,
	PRIMARY KEY(MAGIAMGIA)
)
CREATE TABLE KHACHHANG
(
	MAKHACHHANG VARCHAR(10) NOT NULL,
	TENKHACHHANG NVARCHAR(255),
	SDT VARCHAR(12),
	MATKHAU VARCHAR(50),
	EMAIL NVARCHAR(255),
	DIEMTHUONG FLOAT,
	TINHTRANG INT,
	PRIMARY KEY(MAKHACHHANG)
)
CREATE TABLE DATBAN
(
	MADATBAN VARCHAR(10) NOT NULL,
	THOIGIANNHANBAN DATETIME,
	GHICHU NVARCHAR(250) DEFAULT NULL,
	MAKHACHHANG VARCHAR(10) NOT NULL,
	MABAN INT NOT NULL,
	MANHANVIEN VARCHAR(10) DEFAULT NULL,
	TINHTRANG INT DEFAULT 0
	PRIMARY KEY(MADATBAN)
)

CREATE TABLE HOADON
(
	MAHOADON VARCHAR(10) NOT NULL,
	NGAYLAP DATETIME,
	NGAYXUAT DATETIME,
	TONGTIEN FLOAT,
	THANHTOAN FLOAT,
	MABAN INT,
	MANHANVIEN VARCHAR(10),
	MAKHACHHANG VARCHAR(10),
	MAGIAMGIA VARCHAR(10) DEFAULT NULL,
	PRIMARY KEY(MAHOADON)
)
CREATE TABLE CT_HOADON
(
	MAHOADON VARCHAR(10) NOT NULL,
	MACTMON VARCHAR(10) NOT NULL,
	SOLUONG INT,
	PRIMARY KEY(MAHOADON, MACTMON)
)
CREATE TABLE NHACUNGCAP
(
	MANHACUNGCAP INT IDENTITY NOT NULL,
	TENNHACUNGCAP NVARCHAR(50) NOT NULL,
	SDT VARCHAR(12),
	DIACHI NVARCHAR(255),
	TINHTRANG INT,
	PRIMARY KEY(MANHACUNGCAP)
)
CREATE TABLE NGUYENLIEU
(
	MANGUYENLIEU INT IDENTITY NOT NULL,
	TENNGUYENLIEU NVARCHAR(255) UNIQUE,
	SOLUONG DEC(10,3),
	DVT NVARCHAR(10),
	MANHACUNGCAP INT,
	TINHTRANG INT DEFAULT 0, -- -1 : ĐÃ XÓA. 0 : CÒN. 1 : HẾT 
	PRIMARY KEY(MANGUYENLIEU)
)
CREATE TABLE CONGTHUC
(
	MACTMON VARCHAR(10) NOT NULL,
	MANGUYENLIEU INT NOT NULL,
	HAMLUONG DEC(10,3),
	PRIMARY KEY(MANGUYENLIEU, MACTMON)
)
CREATE TABLE PHIEUDAT
(
	MAPHIEUDAT VARCHAR(10) NOT NULL,
	TENPHIEUDAT NVARCHAR(255),
	NGAYLAP DATETIME,
	TONGTIEN FLOAT,
	TINHTRANG INT,
	MANHANVIEN VARCHAR(10),
	PRIMARY KEY(MAPHIEUDAT)
)
CREATE TABLE CT_PHIEUDAT
(
	MANGUYENLIEU INT NOT NULL,
	MAPHIEUDAT VARCHAR(10) NOT NULL,
	SOLUONG DEC(10,3),
	GIADAT INT,
	PRIMARY KEY(MANGUYENLIEU, MAPHIEUDAT)
)
CREATE TABLE PHIEUNHAP
(
	MAPHIEUNHAP VARCHAR(10) NOT NULL,
	MAPHIEUDAT VARCHAR(10) NOT NULL,
	NGAYNHAP DATETIME,
	NOIDUNG NVARCHAR(250),
	MANHANVIEN VARCHAR(10),
	TINHTRANG INT,
	PRIMARY KEY(MAPHIEUNHAP)
)
CREATE TABLE CT_PHIEUNHAP
(
	MANGUYENLIEU INT NOT NULL,
	MAPHIEUNHAP VARCHAR(10) NOT NULL,
	SOLUONG DEC(10,3),
	PRIMARY KEY(MANGUYENLIEU, MAPHIEUNHAP)
)
-------		THÊM KHÓA NGOẠI CHO CÁC BẢNG	--------
ALTER TABLE NGUOIDUNG
ADD CONSTRAINT FK_NGUOIDUNG_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN) ON DELETE CASCADE

ALTER TABLE LUONGQL
ADD CONSTRAINT FK_BANGLUONG_QUANLY FOREIGN KEY (MABANGLUONG) REFERENCES BANGLUONG(MABANGLUONG),
	CONSTRAINT FK_LUONG_QUANLY FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)

ALTER TABLE LUONGNV
ADD CONSTRAINT FK_BANGLUONG_NHANVIEN FOREIGN KEY (MABANGLUONG) REFERENCES BANGLUONG(MABANGLUONG),
	CONSTRAINT FK_LUONG_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)

alter table CTCHAMCONG_QUANLY
add CONSTRAINT FK_CTCHAMCONG_QUANLY FOREIGN KEY (MACHAMCONG) REFERENCES CHAMCONG_LUONGQL(MACHAMCONG),
CONSTRAINT FK_CTCHAMCONG_QUANLY_CTBANGLUONG FOREIGN KEY (MABANGLUONG,MANHANVIEN,MACA) REFERENCES CTBANGLUONGQL(MABANGLUONG,MANHANVIEN,MACA)

alter table CTBANGLUONGQL
add CONSTRAINT FK_CTBL_CHAMCONG_LUONGQL FOREIGN KEY (MABANGLUONG,MANHANVIEN) REFERENCES LUONGQL(MABANGLUONG,MANHANVIEN),
CONSTRAINT FK_CTBL_CHAMCONG_LUONGQL_CA FOREIGN KEY (MACA) REFERENCES CALAM(MACA)

alter table CTBANGLUONGNV
add CONSTRAINT FK_CTBL_LUONGNV FOREIGN KEY (MABANGLUONG,MANHANVIEN) REFERENCES LUONGNV(MABANGLUONG,MANHANVIEN),
	CONSTRAINT FK_CTBL_LUONGNV_CALAM FOREIGN KEY (MACA) REFERENCES CALAM(MACA)

ALTER TABLE NGUOIDUNGNHOMNGUOIDUNG
ADD CONSTRAINT FK_NGUOIDUNGNHOMNGUOIDUNG_NGUOIDUNG FOREIGN KEY (TENDANGNHAP) REFERENCES NGUOIDUNG(TENDANGNHAP) ON DELETE CASCADE,
	CONSTRAINT FK_NGUOIDUNGNHOMNGUOIDUNG_NHOMNGUOIDUNG FOREIGN KEY (MANHOM) REFERENCES NHOMNGUOIDUNG(MANHOM)

ALTER TABLE PHANQUYEN
ADD CONSTRAINT FK_PHANQUYEN_NHOMNGUOIDUNG FOREIGN KEY(MANHOM) REFERENCES NHOMNGUOIDUNG(MANHOM),
	CONSTRAINT FK_PHANQUYEN_MANHINH FOREIGN KEY(MAMANHINH) REFERENCES MANHINH(MAMANHINH)

ALTER TABLE BAN
ADD CONSTRAINT FK_BAN_KHUVUC FOREIGN KEY (MAKHUVUC) REFERENCES KHUVUC(MAKHUVUC)

ALTER TABLE DATBAN
ADD CONSTRAINT FK_DATBAN_BAN FOREIGN KEY (MABAN) REFERENCES BAN(MABAN) ON DELETE CASCADE,
	CONSTRAINT FK_DATBAN_KHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG) ON DELETE CASCADE
	 

ALTER TABLE THUCDON
ADD CONSTRAINT FK_THUCDON_LOAIMON FOREIGN KEY (MALOAI) REFERENCES LOAIMON(MALOAI)

ALTER TABLE CTTHUCDON
ADD CONSTRAINT FK_CTTHUCDON_THUCDON FOREIGN KEY (MAMON) REFERENCES THUCDON(MAMON) ON DELETE CASCADE

ALTER TABLE HOADON
ADD CONSTRAINT FK_HOADON_BAN FOREIGN KEY (MABAN) REFERENCES BAN(MABAN),
	CONSTRAINT FK_HOADON_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
	CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG),
	CONSTRAINT FK_HOADON_GIAMGIA FOREIGN KEY (MAGIAMGIA) REFERENCES GIAMGIA(MAGIAMGIA)

ALTER TABLE CT_HOADON
ADD CONSTRAINT FK_CT_HOADON_HOADON FOREIGN KEY (MAHOADON) REFERENCES HOADON(MAHOADON),
	CONSTRAINT FK_CT_HOADON_CTTHUCDON FOREIGN KEY (MACTMON) REFERENCES CTTHUCDON(MACTMON)

ALTER TABLE NGUYENLIEU
ADD CONSTRAINT FK_NGUYENLIEU_NHACUNGCAP FOREIGN KEY (MANHACUNGCAP) REFERENCES NHACUNGCAP(MANHACUNGCAP)

ALTER TABLE CONGTHUC
ADD CONSTRAINT FK_CONGTHUC_NGUYENLIEU FOREIGN KEY (MANGUYENLIEU) REFERENCES NGUYENLIEU(MANGUYENLIEU),
	CONSTRAINT FK_CONGTHUC_CTTHUCDON FOREIGN KEY (MACTMON) REFERENCES CTTHUCDON(MACTMON)

ALTER TABLE PHIEUDAT
ADD CONSTRAINT FK_PHIEUDAT_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)

ALTER TABLE CT_PHIEUDAT
ADD CONSTRAINT FK_CT_PHIEUDAT_NGUYENLIEU FOREIGN KEY (MANGUYENLIEU) REFERENCES NGUYENLIEU(MANGUYENLIEU),
	CONSTRAINT FK_CT_PHIEUDAT_PHIEUDAT FOREIGN KEY (MAPHIEUDAT) REFERENCES PHIEUDAT(MAPHIEUDAT)

ALTER TABLE PHIEUNHAP
ADD CONSTRAINT FK_PHIEUNHAP_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
	CONSTRAINT FK_PHIEUNHAP_PHIEUDAT FOREIGN KEY (MAPHIEUDAT) REFERENCES PHIEUDAT(MAPHIEUDAT)

ALTER TABLE CT_PHIEUNHAP
ADD CONSTRAINT FK_CT_PHIEUNHAP_NGUYENLIEU FOREIGN KEY (MANGUYENLIEU) REFERENCES NGUYENLIEU(MANGUYENLIEU),
	CONSTRAINT FK_CT_PHIEUNHAP_PHIEUNHAP FOREIGN KEY (MAPHIEUNHAP) REFERENCES PHIEUNHAP(MAPHIEUNHAP)



-------		NHẬP DỮ LIỆU	--------

SET DATEFORMAT DMY
INSERT INTO NHANVIEN (MANHANVIEN, HOTEN, GIOITINH, NGAYSINH, DIACHI, SDT, NGAYVAOLAM, LUONGCOBAN, CHUCVU, HINHANH)
VALUES
('NV001', N'Ngô Văn Mười', N'Nam', '08/09/1999', N'123 Nguyễn Hữu Tiến, Tây Thạnh, Tân Phú, Tp.Hcm', '0392419643', '30/05/2010', 200000, N'Quản Lý', NULL),
('NV002', N'Chung Tử Đơn', N'Nam', '21/03/1990', N'11 Bàu Bàng, Phường 13, Tân Bình, Tp.HCM', '0935224412', '12/05/2015', 100000, N'FULLTIME', NULL),
('NV003', N'Châu Nhuận Phát ', N'Nam', '15/12/1991', N'64 Đường số 17, Linh Trung, Thủ Đức', '0392419643', '30/05/2010', 120000, N'FULLTIME', N'http://kltnquanlyquancaphe.somee.com/HinhAnh/ChauNhuanPhat.PNG'),
('NV004', N'Lý Gia Hân', N'Nữ', '01/10/1995', N'4 đường D11, P.Tây Thạnh ,Q.Tân Phú, Tp.Hcm', '0924032217', '21/12/2018', 150000, N'Nhân Viên', N'http://kltnquanlyquancaphe.somee.com/HinhAnh/LyGiaHan.jpg'),
('NV005', N'Huỳnh Thúy Như', N'Nữ', '16/02/1993', N'37 Trần Quý Cáp, Phường 11, Q.Bình Thạnh, Tp.Hcm', '0935124588', '04/11/2019', 120000, N'Nhân Viên', NULL)

INSERT INTO NGUOIDUNG (TENDANGNHAP, MATKHAU, TRANGTHAI, MANHANVIEN)
VALUES
('ngo10','1',N'Hoạt động','NV001'),
('donkk','1',N'Hoạt động','NV002'),
('thanbai123','1',N'Hoạt động','NV003'),
('giahan','1',N'Khóa','NV004'),
('nhuhuynh','1',N'Hoạt động','NV005')

INSERT INTO NHOMNGUOIDUNG (MANHOM, TENNHOM, GHICHU)
VALUES
('admin',N'Quản Lý',N'Nhóm này dành cho quản lý'),
('NhanVien',N'Nhân Viên',N'Nhóm dành cho nhân viên thông thường'),
('NhanVienPre',N'Nhân Viên Pre',N'Thêm một số quyền cho nhân viên xịn')

INSERT INTO NGUOIDUNGNHOMNGUOIDUNG (TENDANGNHAP, MANHOM, GHICHU)
VALUES
('ngo10','admin',N'không có ghi chú'),
('donkk','NhanVien',N'hihi'),
('thanbai123','NhanVien',N'anh phát thần bài'),
('giahan','NhanVien',N'hân hân'),
('nhuhuynh','NhanVien',N'như nè')

INSERT INTO MANHINH (MAMANHINH, TENMANHINH)
VALUES
('MHXTTB',N'MH Xem thông tin bàn'),
('MHQLDB',N'MH Xử lý đặt bàn'),
('MHQL',N'MH Quản lý'),
('MHTK',N'MH Quản lý')

INSERT INTO PHANQUYEN (MANHOM, MAMANHINH, COQUYEN)
VALUES
('admin','MHXTTB',1),
('admin','MHQLDB',1),
('admin','MHQL',1),
('admin','MHTK',1),
('NhanVien','MHXTTB',1),
('NhanVien','MHQLDB',0),
('NhanVien','MHQL',0),
('NhanVien','MHTK',0),
('NhanVienPre','MHXTTB',1),
('NhanVienPre','MHQLDB',0),
('NhanVienPre','MHQL',0),
('NhanVienPre','MHTK',0)

INSERT INTO LOAIMON (MALOAI, TENLOAI)
VALUES
('L001', N'Cà Phê'),
('L002', N'Trà'),
('L003', N'Bánh')

INSERT INTO THUCDON (MAMON, TENMON, MALOAI, DVT, HINHANH)
VALUES
('M001', N'Cà Phê Đen', 'L001', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/05_2018/thumbs/270_crop_CFD.png'),
('M002', N'Cà Phê Sữa', 'L001', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/04_2020/thumbs/270_crop_Bac_Xiu_Da.png'),
('M003', N'Cà Phê Phin Sữa Đá', 'L001', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_PHIN-SUA-DA.png'),
('M004', N'CÀ PHÊ ESPRESSO', 'L001', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/05_2018/thumbs/270_crop_ESPRESSO.png'),
('M005', N'Trà Thanh Đào', 'L002', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/TRATHANHDAO.png'),
('M006', N'Trà Sen Vàng', 'L002', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/TRASENVANG.png'),
('M007', N'Trà Thạch Vải', 'L002', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/04_2020/TRATHACHVAI_1.png'),
('M008', N'Trà Thạch Đào', 'L002', N'Ly', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/TRATHACHDAO.png'),
('M009', N'Bánh Chuối', 'L003', N'Cái', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_BANHCHUOI.jpg'),
('M010', N'Bánh Mousse Ca Cao', 'L003', N'Cái', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_MOUSSECACAO.png'),
('M011', N'Bánh SÔ-CÔ-LA HIGHLANDS', 'L003', N'Cái', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_SOCOLAHL.png'),
('M012', N'Bánh Phô Mai Cà Phê', 'L003', N'Cái', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_PHOMAICAPHE.jpg'),
('M013', N'Bánh Mousse Đào', 'L003', N'Cái', N'https://www.highlandscoffee.com.vn/vnt_upload/product/03_2018/thumbs/270_crop_MOUSSEDAO.png')

INSERT INTO CTTHUCDON
VALUES
('M00101', 'S', 21000, 'M001'),
('M00102', 'M', 21000, 'M001'),
('M00201', 'S', 27000, 'M002'),
('M00202', 'M', 31000, 'M002'),
('M00203', 'L', 35000, 'M002'),
('M00301', 'S', 29000, 'M003'),
('M00302', 'M', 35000, 'M003'),
('M00303', 'L', 39000, 'M003'),
('M00401', 'M', 44000, 'M004'),
('M00402', 'L', 54000, 'M004'),
('M00501', 'S', 39000, 'M005'),
('M00502', 'M', 49000, 'M005'),
('M00503', 'L', 55000, 'M005'),
('M00601', 'S', 39000, 'M006'),
('M00602', 'M', 49000, 'M006'),
('M00603', 'L', 55000, 'M006'),
('M00701', 'S', 39000, 'M007'),
('M00702', 'M', 49000, 'M007'),
('M00703', 'L', 55000, 'M007'),
('M00801', 'S', 39000, 'M008'),
('M00802', 'M', 49000, 'M008'),
('M00803', 'L', 55000, 'M008'),
('M00901', 'M', 19000, 'M009'),
('M00902', 'L', 24000, 'M009'),
('M01001', 'M', 29000, 'M010'),
('M01101', 'M', 29000, 'M011'),
('M01201', 'M', 29000, 'M012'),
('M01301', 'M', 29000, 'M013')

INSERT INTO NHACUNGCAP
VALUES
(N'Cty TNHH MTV Ngô Mười',0392419643,N'123 Nguyễn Hữu Tiến, Tây Thạnh, Tân Phú, TP.HCM',0),
(N'Bartenders’ Mart Nhất Hương',0911789697,N'155 Tân Kỳ Tân Quý, phường Tân Sơn Nhì, quận Tân Phú',0),
(N'Beemart',1900636546,N'Số 212 Âu Cơ, Q. Tân Bình',0),
(N'Siêu thị DVP (Đại Vạn Phát)',0907309988,N'259B Hai Bà Trưng, P6, Q3, TP HCM',0)

INSERT INTO NGUYENLIEU
VALUES
(N'Bột cà phê truyền thống', 5, N'Kg', 1, 0),
(N'Sữa tươi nguyên kem', 5, N'Lít', 1, 0),
(N'Bột sữa Vanablanca', 1, N'Kg', 1, 0),
(N'Bột cacao', 1, N'Kg', 1, 0),
(N'Đường trắng Biên Hòa DAILY', 2, N'Kg', 1, 0),
(N'Hồng trà (trà đen) Hoàng Gia Premium Tea', 1, N'Kg', 1, 0),
(N'Bột sữa thực vật', 2, N'Kg', 2, 0),
(N'Bột sắn', 1, N'Kg', 2, 0),
(N'Bột rau câu dẻo', 1, N'Kg', 2, 0),
(N'Đường thốt nốt An Giang', 1, N'Kg', 1, 0),
(N'Sữa đặc có đường Ngôi Sao Phương Nam', 2, N'Lít', 3, 0),
(N'Bột năng', 1, N'Kg', 1, 0),
(N'Dầu ăn', 1, N'Lít', 4, 0),
(N'Muối I ốt', 1, N'Kg', 1, 0),
(N'Đào ngâm', 2, N'Hộp', 1, 0),
(N'Vải ngâm', 2, N'Hộp', 1, 0),
(N'Hạt sen', 1, N'Kg', 1, 0),
(N'Siro đào', 1, N'Kg', 4, 0),
(N'Siro vải', 1, N'Kg', 4, 0),
(N'Đá viên', 1, N'Kg', 3, 0),
(N'Chuối quả', 1, N'Kg', 3, 0),
(N'Phô mai', 1, N'Hộp', 2, 0),
(N'Bánh mì', 10, N'Ổ', 1, 0)

INSERT INTO CONGTHUC
VALUES
('M00101',1, 0.1),
('M00101',20, 0.1),
('M00102',1, 0.2),
('M00201',1, 0.15),
('M00201',2, 0.1),
('M00201',20, 0.1),
('M00202',1, 0.2),
('M00202',2, 0.15),
('M00202',20, 0.15),
('M00203',1, 0.25),
('M00203',2, 0.2),
('M00203',20, 0.2),
('M00301',1, 0.2),
('M00301',11, 0.1),
('M00301',20, 0.1),
('M00302',1, 0.25),
('M00302',11, 0.15),
('M00302',20, 0.15),
('M00303',1, 0.3),
('M00303',11, 0.2),
('M00303',20, 0.2),
('M00401',1, 0.1),
('M00401',2, 0.1),
('M00401',20, 0.1),
('M00402',1, 0.15),
('M00402',2, 0.15),
('M00402',20, 0.1),
('M00501',6, 0.2),
('M00501',5, 0.1),
('M00501',15, 0.1),
('M00501',18, 0.1),
('M00501',20, 0.1),
('M00502',6, 0.2),
('M00502',5, 0.15),
('M00502',15, 0.15),
('M00502',18, 0.15),
('M00502',20, 0.15),
('M00503',6, 0.25),
('M00503',5, 0.2),
('M00503',15, 0.2),
('M00503',18, 0.2),
('M00503',20, 0.2),
('M00601',6, 0.2),
('M00601',5, 0.1),
('M00601',17, 0.1),
('M00601',20, 0.1),
('M00602',6, 0.25),
('M00602',5, 0.15),
('M00602',17, 0.15),
('M00602',20, 0.15),
('M00603',6, 0.25),
('M00603',5, 0.15),
('M00603',17, 0.15),
('M00603',20, 0.15),
('M00701',6, 0.2),
('M00701',5, 0.1),
('M00701',16, 0.1),
('M00701',19, 0.1),
('M00701',20, 0.1),
('M00701',12, 0.5),
('M00701',11, 0.5),
('M00702',6, 0.25),
('M00702',5, 0.15),
('M00702',16, 0.1),
('M00702',20, 0.15),
('M00702',12, 0.1),
('M00702',19, 0.1),
('M00702',11, 0.1),
('M00703',6, 0.28),
('M00703',5, 0.2),
('M00703',16, 0.15),
('M00703',20, 0.15),
('M00703',12, 0.2),
('M00703',19, 0.2),
('M00703',11, 0.2),
('M00801',6, 0.2),
('M00801',5, 0.1),
('M00801',15, 0.1),
('M00801',18, 0.1),
('M00801',20, 0.1),
('M00801',12, 0.05),
('M00801',19, 0.05),
('M00801',11, 0.05),
('M00802',6, 0.2),
('M00802',5, 0.1),
('M00802',15, 0.1),
('M00802',18, 0.1),
('M00802',20, 0.1),
('M00802',12, 0.1),
('M00802',19, 0.1),
('M00802',11, 0.1),
('M00803',6, 0.2),
('M00803',5, 0.1),
('M00803',15, 0.1),
('M00803',18, 0.1),
('M00803',20, 0.1),
('M00803',12, 0.15),
('M00803',19, 0.15),
('M00803',11, 0.15),
('M00901',8, 0.2),
('M00901',21, 0.15),
('M00901',5, 0.15),
('M00901',13, 0.3),
('M00901',3, 0.3),
('M00902',8, 0.2),
('M00902',21, 0.2),
('M00902',5, 0.2),
('M00902',13, 0.3),
('M00902',3, 0.2),
('M01001',8, 0.2),
('M01001',4, 0.2),
('M01001',5, 0.2),
('M01001',13, 0.3),
('M01001',3, 0.2),
('M01101',8, 0.2),
('M01101',4, 0.5),
('M01101',5, 0.2),
('M01101',13, 0.3),
('M01101',3, 0.2),
('M01201',8, 0.2),
('M01201',1, 0.1),
('M01201',5, 0.2),
('M01201',13, 0.3),
('M01201',3, 0.2),
('M01201',22, 0.2)


INSERT INTO KHUVUC (MAKHUVUC, TENKHUVUC)
VALUES
('KV001', N'Sảnh Trước'),
('KV002', N'Phòng Máy Lạnh 1'),
('KV003', N'Phòng Máy Lạnh 2'),
('KV004', N'Lầu 2')

INSERT INTO BAN (TENBAN, SOCHONGOI, TRANGTHAI, MAKHUVUC)
VALUES
(N'Bàn 1', 4, N'Trống', 'KV001'),
(N'Bàn 2', 2, N'Trống', 'KV001'),
(N'Bàn 3', 4, N'Trống', 'KV001'),
(N'Bàn 4', 4, N'Trống', 'KV001'),
(N'Bàn 5', 6, N'Trống', 'KV001'),
(N'Bàn 6', 2, N'Trống', 'KV001'),
(N'Bàn 7', 2, N'Trống', 'KV002'),
(N'Bàn 8', 4, N'Trống', 'KV002'),
(N'Bàn 9', 4, N'Trống', 'KV002'),
(N'Bàn 10', 6, N'Trống', 'KV002'),
(N'Bàn 11', 2, N'Trống', 'KV002'),
(N'Bàn 12', 4, N'Trống', 'KV002'),
(N'Bàn 13', 4, N'Trống', 'KV003'),
(N'Bàn 14', 4, N'Trống', 'KV003'),
(N'Bàn 15', 10, N'Trống', 'KV003'),
(N'Bàn 16', 4, N'Trống', 'KV003'),
(N'Bàn 17', 4, N'Trống', 'KV004'),
(N'Bàn 18', 4, N'Trống', 'KV004'),
(N'Bàn 19', 4, N'Trống', 'KV004'),
(N'Bàn 20', 4, N'Trống', 'KV004')

INSERT INTO KHACHHANG (MAKHACHHANG, TENKHACHHANG, SDT, MATKHAU, EMAIL, DIEMTHUONG, TINHTRANG)
VALUES
('KH001', N'Khách lẻ', NULL, NULL, NULL, 0, 0),
('KH002', N'Tiêu Phong', '0392419643', '123456', N'tieuphong1@gmail.com', 1500, 0),
('KH003', N'Lý Mạc Sầu', '0123456789', '123456', N'hihi@gmail.com', 0, 0),
('KH004', N'Tiểu Long Nữ', '0936540122', '123456', N'coconut@gmail.com', 3526, 0),
('KH005', N'Shark Bình', '0936540123', '123456', N'coconut@gmail.com', 0, 0),
('KH006', N'Khả Như', '0921336602', '123456', N'nhunhu02@gmail.com', 0, 0),
('KH007', N'Khác Việt', '0123411028', '123456', N'anhkhachayemkhac@gmail.com', 0, 0),
('KH008', N'Vương Quốc Tuân', '0392410099', '123456', N'mrsiro@gmail.com', 5652, 0),
('KH009', N'Trần Nguyễn Minh Nghi', '0316640170', '123456', N'minhnghi112@gmail.com', 0, 0),
('KH010', N'Thầy Giáo Ba', '0392416653', '123456', N'susan0175@gmail.com', 0, 0),
('KH011', N'Diễm My', '031254021', '123456', N'diemmyttbl@gmail.com', 0, -1),
('KH012', N'Trương Thế Vinh', '0321414252', '123456', N'voibienrm@gmail.com', 0, 0),
('KH013', N'Lê Bống', '0958635241', '123456', N'lebongtiktok@gmail.com', 10253, 0),
('KH014', N'Hùng Bá', '0963251145', '123456', N'vuatiente@gmail.com', 0, 1),
('KH015', N'Tùng Núi', '0976340012', '123456', N'tungnuimtp@gmail.com', 0, 0)


--------========================== TẠO TRIGGER
---- TRIGGER TÍNH SỐ LƯỢNG NGUYÊN LIỆU KHI NHẬP
GO
CREATE TRIGGER TRG_NHAPNGUYENLIEU
ON CT_PHIEUNHAP FOR INSERT
AS
BEGIN
	UPDATE NGUYENLIEU
	SET SOLUONG = NGUYENLIEU.SOLUONG + (SELECT soLuong FROM inserted WHERE inserted.MAPHIEUNHAP = MAPHIEUNHAP AND inserted.MANGUYENLIEU = MANGUYENLIEU)
	FROM inserted
	WHERE NGUYENLIEU.MANGUYENLIEU = inserted.MANGUYENLIEU And MAPHIEUNHAP = inserted.MAPHIEUNHAP 
END;



--------------------------------- Tạo View Hỗ trợ report --------------------
---- In hóa đơn
GO
CREATE VIEW RPHOADON
AS
SELECT HD.MAHOADON, B.MABAN, B.TENBAN, KH.TENKHACHHANG, NV.HOTEN, TD.TENMON, CTTD.Size, CTTD.GIA, CT.SOLUONG, HD.NGAYLAP, HD.NGAYXUAT,
	   HD.TONGTIEN, HD.THANHTOAN, HD.MAGIAMGIA
FROM HOADON HD, BAN B, CT_HOADON CT, NHANVIEN NV, KHACHHANG KH, THUCDON TD, CTTHUCDON CTTD
WHERE HD.MANHANVIEN = NV.MANHANVIEN AND
	  HD.MAKHACHHANG = KH.MAKHACHHANG AND
	  HD.MABAN = B.MABAN AND
	  CT.MAHOADON = HD.MAHOADON AND
	  CT.MACTMON = CTTD.MACTMON AND
	  TD.MAMON = CTTD.MAMON 
GROUP BY HD.MAHOADON , B.MABAN, B.TENBAN, KH.TENKHACHHANG, NV.HOTEN, TD.TENMON, CTTD.Size, CTTD.GIA, CT.SOLUONG, HD.NGAYLAP, HD.NGAYXUAT,
	   HD.TONGTIEN, HD.THANHTOAN, HD.MAGIAMGIA

---- In phiếu đặt
GO
CREATE VIEW RPPHIEUDAT
AS
SELECT PD.MAPHIEUDAT, PD.NGAYLAP, NCC.TENNHACUNGCAP, NCC.DIACHI, NCC.SDT, NL.TENNGUYENLIEU, NL.DVT, CT.SOLUONG, CT.GIADAT, PD.TONGTIEN, NV.HOTEN
FROM PHIEUDAT PD, CT_PHIEUDAT CT, NGUYENLIEU NL, NHACUNGCAP NCC, NHANVIEN NV
WHERE PD.MAPHIEUDAT = CT.MAPHIEUDAT AND
	  CT.MANGUYENLIEU = NL.MANGUYENLIEU AND
	  NL.MANHACUNGCAP = NCC.MANHACUNGCAP AND
	  PD.MANHANVIEN = NV.MANHANVIEN
GROUP BY  PD.MAPHIEUDAT, PD.NGAYLAP, NCC.TENNHACUNGCAP, NCC.DIACHI, NCC.SDT, NL.TENNGUYENLIEU, NL.DVT, CT.SOLUONG, CT.GIADAT, PD.TONGTIEN, NV.HOTEN

---- In phiếu nhập
GO
CREATE VIEW RPPHIEUNHAP
AS
SELECT PN.MAPHIEUDAT, PN.MAPHIEUNHAP, PN.NGAYNHAP, NCC.TENNHACUNGCAP, NCC.DIACHI, NCC.SDT, NL.TENNGUYENLIEU, NL.DVT, CT.SOLUONG, NV.HOTEN
FROM PHIEUDAT PD, PHIEUNHAP PN, CT_PHIEUNHAP CT, NGUYENLIEU NL, NHACUNGCAP NCC, NHANVIEN NV
WHERE PD.MAPHIEUDAT = PN.MAPHIEUDAT AND
	  PN.MAPHIEUNHAP = CT.MAPHIEUNHAP AND
	  CT.MANGUYENLIEU = NL.MANGUYENLIEU AND
	  NL.MANHACUNGCAP = NCC.MANHACUNGCAP AND
	  PD.MANHANVIEN = NV.MANHANVIEN
GROUP BY  PN.MAPHIEUDAT, PN.MAPHIEUNHAP, PN.NGAYNHAP, NCC.TENNHACUNGCAP, NCC.DIACHI, NCC.SDT, NL.TENNGUYENLIEU, NL.DVT, CT.SOLUONG, NV.HOTEN
-- Thủ tục lấy thông tin RPPhieuDat
GO
CREATE PROCEDURE CF_RPPHIEUDAT_GET
(
	@MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	SELECT *
	FROM RPPHIEUDAT
	WHERE MAPHIEUDAT = @MAPHIEUDAT
END;
-- Thủ tục lấy thông tin RPPhieuNhap
GO
CREATE PROCEDURE CF_RPPHIEUNHAP_GET
(
	@MAPHIEUNHAP		VARCHAR(10)
)
AS
BEGIN
	SELECT *
	FROM RPPHIEUNHAP
	WHERE MAPHIEUNHAP = @MAPHIEUNHAP
END;
													----- CÁC THỦ TỤC -----------

										------------------ Phân Quyền ---------------------
--Thủ tục lấy danh sách nhóm người dùng
GO
CREATE PROCEDURE CF_NHOMNGUOIDUNG_GET
AS
BEGIN
	SELECT *
	FROM dbo.NHOMNGUOIDUNG
END;


--Thủ tục lấy danh sách phân quyền
GO
CREATE PROCEDURE CF_PHANQUYEN_GET
AS
BEGIN
	SELECT *
	FROM dbo.PHANQUYEN
END;

--Thủ tục cập nhật phân quyền
GO
CREATE PROCEDURE CF_PHANQUYEN_UPD
(
	@V_MANHOM		   VARCHAR(10),
	@V_MAMANHINH	   VARCHAR(10),
	@V_COQUYEN		   bit
)
AS
BEGIN
	UPDATE PHANQUYEN
	SET COQUYEN = @V_COQUYEN
	WHERE MANHOM = @V_MANHOM AND MAMANHINH = @V_MAMANHINH
END;

--Thủ tục lấy danh sách màn hình
GO
CREATE PROCEDURE CF_MANHINH_GET
AS
BEGIN
	SELECT *
	FROM dbo.MANHINH
END;

--Thủ tục lấy nhóm người dùng theo tên đăng nhập
GO
CREATE PROCEDURE CF_NGUOIDUNGNHOMNGUOIDUNG_GET
(
	@V_TENDANGNHAP         NVARCHAR(MAX)
)
AS
BEGIN
	SELECT *
	FROM dbo.NGUOIDUNGNHOMNGUOIDUNG
	WHERE TENDANGNHAP = @V_TENDANGNHAP
END;

--Thủ tục thêm người dùng vào nhóm
GO
CREATE PROCEDURE CF_NGUOIDUNGNHOMNGUOIDUNG_ADD
(
	@V_TENDANGNHAP		VARCHAR(50),
	@V_MANHOM			VARCHAR(20)
)
AS
BEGIN
	INSERT INTO NGUOIDUNGNHOMNGUOIDUNG (TENDANGNHAP, MANHOM)
	VALUES
	(@V_TENDANGNHAP,
	@V_MANHOM)
END;

									------------------ Người Dùng ---------------------
--Thủ tục lấy thông tin người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_GET
(
	@V_TENDANGNHAP     NVARCHAR(MAX),
	@V_MATKHAU		INT
)
AS
BEGIN
	SELECT ND.TENDANGNHAP, ND.TRANGTHAI, ND.MANHANVIEN, NV.HOTEN, NV.CHUCVU
	FROM dbo.NGUOIDUNG ND, dbo.NHANVIEN NV
	WHERE @V_TENDANGNHAP = TENDANGNHAP AND @V_MATKHAU = MATKHAU AND ND.MANHANVIEN = NV.MANHANVIEN
END;

--Thủ tục lấy danh sách người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_SRH
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT -----0: Tìm theo mã nhân viên, 1: Tìm theo tên nhân viên
)
AS
BEGIN
	SELECT ND.MANHANVIEN, NV.HOTEN, ND.TENDANGNHAP, ND.MATKHAU, ND.TRANGTHAI 
	FROM dbo.NGUOIDUNG ND, dbo.NHANVIEN NV
	WHERE  ND.MANHANVIEN = NV.MANHANVIEN AND
		((@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND ND.MANHANVIEN LIKE '%' + RTRIM(@V_KEYWORD) +'%')
        OR
        (@V_SEARCHTYPE = 1 AND HOTEN LIKE '%' + RTRIM(@V_KEYWORD) +'%'))
	ORDER BY ND.MANHANVIEN
END;

--Thủ tục lấy danh sách nhân viên chưa có tài khoản người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_NO
AS
BEGIN
	SELECT MANHANVIEN, HOTEN, SDT
FROM NHANVIEN
WHERE NOT EXISTS (
	SELECT * 
	FROM NGUOIDUNG 
	WHERE NHANVIEN.MANHANVIEN = NGUOIDUNG.MANHANVIEN
	)
END;

--Thủ tục thêm tài khoản người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_ADD
(
	@V_TENDANGNHAP		VARCHAR(50),
	@V_MATKHAU			VARCHAR(50),
	@V_TRANGTHAI		NVARCHAR(20),
	@V_MANHANVIEN		VARCHAR(10)
)
AS
BEGIN
	INSERT INTO NGUOIDUNG
	VALUES
	(@V_TENDANGNHAP,
	@V_MATKHAU,
	@V_TRANGTHAI,
	@V_MANHANVIEN)
END;

--Thủ tục cập nhật tài khoản người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_UPD
(
	@V_TENDANGNHAP		VARCHAR(50),
	@V_MATKHAU			VARCHAR(50),
	@V_TRANGTHAI		NVARCHAR(20)
)
AS
BEGIN
	UPDATE NGUOIDUNG
	SET MATKHAU = @V_MATKHAU,
		TRANGTHAI = @V_TRANGTHAI
	WHERE TENDANGNHAP = @V_TENDANGNHAP
END;

--Thủ tục xóa tài khoản người dùng
GO
CREATE PROCEDURE CF_NGUOIDUNG_DEL
(
	@V_TENDANGNHAP		VARCHAR(50)
)
AS
BEGIN
	DELETE NGUOIDUNG
	WHERE TENDANGNHAP = @V_TENDANGNHAP
END;

----------------- NHóm người dùng--------
--Thủ tục lấy danh sách nhóm người dùng
GO
CREATE PROCEDURE CF_NHOMGUOIDUNG_SRH
AS
BEGIN
	SELECT *
	FROM NHOMNGUOIDUNG
END;

--Thủ tục thêm mới nhóm người dùng
GO
CREATE PROCEDURE CF_NHOMGUOIDUNG_ADD
(
	@V_MANHOM VARCHAR(20),
	@V_TENNHOM NVARCHAR(50),
	@V_GHICHU NVARCHAR(200)
)
AS
BEGIN
	INSERT INTO NHOMNGUOIDUNG
	VALUES
		  (@V_MANHOM,
		   @V_TENNHOM,
		   @V_GHICHU)
END;

--Thủ tục cập nhật nhóm người dùng
GO
CREATE PROCEDURE CF_NHOMGUOIDUNG_UPD
(
	@V_MANHOM VARCHAR(20),
	@V_TENNHOM NVARCHAR(50),
	@V_GHICHU NVARCHAR(200)
)
AS
BEGIN
	UPDATE NHOMNGUOIDUNG
	SET TENNHOM = @V_TENNHOM,
		GHICHU = @V_GHICHU
	WHERE MANHOM = @V_MANHOM
END;
	
--Thủ tục xóa nhóm người dùng
GO
CREATE PROCEDURE CF_NHOMGUOIDUNG_DEL
(
	@V_MANHOM VARCHAR(20)
)
AS
BEGIN
	DELETE NHOMNGUOIDUNG
	WHERE MANHOM = @V_MANHOM
END;
								------------------ Nhân Viên ---------------------
--Thủ tục tìm kiếm nhân viên
GO
CREATE PROCEDURE CF_NHANVIEN_SRH
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT -----0: Tìm theo mã nhân viên, 1: Tìm theo tên nhân viên
)
AS
BEGIN
	SELECT * 
	FROM dbo.NHANVIEN
	WHERE (@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND MANHANVIEN LIKE '%' + RTRIM(@V_KEYWORD) +'%')
        OR
        (@V_SEARCHTYPE = 1 AND HOTEN LIKE '%' + RTRIM(@V_KEYWORD) +'%')
END;

--Thủ tục sửa nhân viên
GO
CREATE PROCEDURE CF_NHANVIEN_UPD
(
	@V_MANHANVIEN      VARCHAR(10),
	@V_HOTEN		   NVARCHAR(50),
	@V_GIOITINH		   NVARCHAR(3),
	@V_NGAYSINH		   DATE,
	@V_DIACHI		   NVARCHAR(250),
	@V_SDT		       VARCHAR(12),
	@V_NGAYVAOLAM	   DATE,
	@V_LUONGCOBAN	   INT,
	@V_CHUCVU	       NVARCHAR(20),
	@V_HINHANH	       NVARCHAR(MAX)
)
AS
BEGIN
	UPDATE dbo.NHANVIEN
	SET HOTEN = @V_HOTEN,
		GIOITINH = @V_GIOITINH,
		NGAYSINH = @V_NGAYSINH,
		DIACHI = @V_DIACHI,
		SDT = @V_SDT,
		NGAYVAOLAM = @V_NGAYVAOLAM,
		LUONGCOBAN = @V_LUONGCOBAN,
		CHUCVU = @V_CHUCVU,
		HINHANH = @V_HINHANH
	WHERE MANHANVIEN = @V_MANHANVIEN
END;

--Thủ tục thêm nhân viên
GO
CREATE PROCEDURE CF_NHANVIEN_ADD
(
	@V_MANHANVIEN      VARCHAR(10),
	@V_HOTEN		   NVARCHAR(50),
	@V_GIOITINH		   NVARCHAR(3),
	@V_NGAYSINH		   DATE,
	@V_DIACHI		   NVARCHAR(250),
	@V_SDT		       VARCHAR(12),
	@V_NGAYVAOLAM	   DATE,
	@V_LUONGCOBAN	   INT,
	@V_CHUCVU	       NVARCHAR(20),
	@V_HINHANH	       NVARCHAR(MAX)
)
AS
BEGIN
	INSERT INTO dbo.NHANVIEN
	VALUES 
		  (@V_MANHANVIEN, 
		  @V_HOTEN, 
		  @V_GIOITINH, 
		  @V_NGAYSINH, 
		  @V_DIACHI, 
		  @V_SDT, 
		  @V_NGAYVAOLAM, 
		  @V_LUONGCOBAN, 
		  @V_CHUCVU, 
		  @V_HINHANH,
		  0)
END;

--Thủ xóa thêm nhân viên
GO
CREATE PROCEDURE CF_NHANVIEN_DEL
(
	@V_MANHANVIEN      VARCHAR(10)
)
AS
BEGIN
	DELETE 
	FROM dbo.NHANVIEN
	WHERE MANHANVIEN = @V_MANHANVIEN
END;
									------------------ Khách Hàng ---------------------
--Thủ tục tìm kiếm khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_SRH
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT, -----0: Tìm theo mã khách hàng, 1: Tìm theo tên khách hàng, 2: Tìm theo sđt, -1: Lấy tất cả (theo tình trạng)
	@V_TINHTRANG	   INT ------0: hoạt động, 1: đã khóa, -1: đã xóa.
)
AS
BEGIN
	SELECT * 
	FROM dbo.KHACHHANG
	WHERE
		TINHTRANG = @V_TINHTRANG AND
		((@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND MAKHACHHANG = @V_KEYWORD)
        OR
        (@V_SEARCHTYPE = 1 AND TENKHACHHANG LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		OR
        (@V_SEARCHTYPE = 2 AND SDT = @V_KEYWORD))
END;

--Thủ tục lấy thông tin khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_GET
(
	@V_MAKHACHHANG         VARCHAR(10)
)
AS
BEGIN
	SELECT * 
	FROM dbo.KHACHHANG
	WHERE MAKHACHHANG = @V_MAKHACHHANG
END;

--Thủ tục cập nhật điểm thưởng khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_UPDDIEM
(
	@V_MAKHACHHANG         VARCHAR(10),
	@V_DIEMTHUONG		   FLOAT
)
AS
BEGIN
	UPDATE dbo.KHACHHANG
	SET DIEMTHUONG = @V_DIEMTHUONG
	WHERE MAKHACHHANG = @V_MAKHACHHANG
END;

--Thủ tục lấy danh sách khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_LOAD
AS
BEGIN
	SELECT *
	FROM KHACHHANG
END;

--Thủ tục thêm thông tin khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_ADD
(
	@V_MAKHACHHANG		VARCHAR(10),
	@V_TENKHACHHANG		NVARCHAR(255),
	@V_SDT				VARCHAR(12),
	@V_MATKHAU			VARCHAR(50),
	@V_EMAIL			NVARCHAR(255),
	@V_DIEMTHUONG		FLOAT
)
AS
BEGIN
	INSERT INTO KHACHHANG
	VALUES (@V_MAKHACHHANG,
			@V_TENKHACHHANG,
			@V_SDT,
			@V_MATKHAU,
			@V_EMAIL,
			@V_DIEMTHUONG,
			0)
END;

--Thủ tục cập nhật thông tin khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_UPD
(
	@V_MAKHACHHANG		VARCHAR(10),
	@V_TENKHACHHANG		NVARCHAR(255),
	@V_SDT				VARCHAR(12),
	@V_MATKHAU			VARCHAR(50),
	@V_EMAIL			NVARCHAR(255),
	@V_DIEMTHUONG		FLOAT,
	@V_TINHTRANG		INT
)
AS
BEGIN
	UPDATE KHACHHANG
	SET TENKHACHHANG = @V_TENKHACHHANG,
		SDT = @V_SDT,
		MATKHAU = @V_MATKHAU,
		EMAIL = @V_EMAIL,
		DIEMTHUONG = @V_DIEMTHUONG,
		TINHTRANG = @V_TINHTRANG
	WHERE MAKHACHHANG = @V_MAKHACHHANG
END;

--Thủ tục XÓA thông tin khách hàng
GO
CREATE PROCEDURE CF_KHACHHANG_DEL
(
	@V_MAKHACHHANG		VARCHAR(10)
)
AS
BEGIN
	UPDATE KHACHHANG
	SET TINHTRANG = -1
	WHERE MAKHACHHANG = @V_MAKHACHHANG
END;
									------------------ Khu Vực ---------------------
--Thủ tục lấy danh sách khu vực
GO
CREATE PROCEDURE CF_KHUVUC_GET
AS
BEGIN
	SELECT * 
	FROM dbo.KHUVUC
END;
									------------------ Bàn ---------------------
--Thủ tục lấy danh sách bàn
GO
CREATE PROCEDURE CF_BAN_GET
AS
BEGIN
	SELECT * 
	FROM dbo.BAN
END;

--Thủ tục cập nhật tình trạng bàn
GO
CREATE PROCEDURE CF_CAPNHATTINHTRANGBAN
(
	@V_MABAN		INT,
	@V_TRANGTHAI	NVARCHAR(MAX)
)
AS
BEGIN
	UPDATE dbo.BAN
	SET TRANGTHAI = @V_TRANGTHAI
	WHERE MABAN = @V_MABAN
END;
									------------------ Loại Món ---------------------
--Thủ tục lấy danh sách Loại món
GO
CREATE PROCEDURE CF_LOAIMON_GET
AS
BEGIN
	SELECT * 
	FROM dbo.LOAIMON
	ORDER BY MALOAI
END;

--Thủ tục thêm Loại món
GO
CREATE PROCEDURE CF_LOAIMON_ADD
(
	@V_MALOAI	VARCHAR(10),
	@V_TENLOAI  NVARCHAR(255)
)
AS
BEGIN
	INSERT INTO LOAIMON
	VALUES (@V_MALOAI, @V_TENLOAI)
END;

--Thủ tục sửa Loại món
GO
CREATE PROCEDURE CF_LOAIMON_UPD
(
	@V_MALOAI	VARCHAR(10),
	@V_TENLOAI  NVARCHAR(255)
)
AS
BEGIN
	UPDATE LOAIMON
	SET TENLOAI = @V_TENLOAI
	WHERE MALOAI = @V_MALOAI
END;

--Thủ tục xóa Loại món
GO
CREATE PROCEDURE CF_LOAIMON_DEL
(
	@V_MALOAI	VARCHAR(10)
)
AS
BEGIN
	DELETE LOAIMON
	WHERE MALOAI = @V_MALOAI
END;
									------------------ Thực Đơn ---------------------
--Thủ tục tìm kiếm thực đơn
GO
CREATE PROCEDURE CF_THUCDON_GM 
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT -----0: Tìm theo mã món, 1: Tìm theo tên món
)
AS
BEGIN
	SELECT TD.MAMON, TD.TENMON, TD.MALOAI, TD.HINHANH, CT.MACTMON, CT.Size, CT.GIA
	FROM THUCDON TD, CTTHUCDON CT
	WHERE TD.MAMON = CT.MAMON AND 
		((@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND TD.MAMON LIKE '%' + RTRIM(@V_KEYWORD) +'%')
        OR
        (@V_SEARCHTYPE = 1 AND TENMON LIKE '%' + RTRIM(@V_KEYWORD) +'%'))
END;

--Thủ tục tìm kiếm thực đơn khi gọi món
GO
CREATE PROCEDURE CF_THUCDON_SRH 
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT -----0: Tìm theo mã món, 1: Tìm theo tên món
)
AS
BEGIN
	SELECT * 
	FROM dbo.THUCDON
	WHERE (@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND MAMON LIKE '%' + RTRIM(@V_KEYWORD) +'%')
        OR
        (@V_SEARCHTYPE = 1 AND TENMON LIKE '%' + RTRIM(@V_KEYWORD) +'%')
END;

--Thủ tục tìm kiếm thực đơn theo loại
GO
CREATE PROCEDURE CF_THUCDON_LOAI
(
	@V_MALOAI         VARCHAR(10)
)
AS
BEGIN
	SELECT * 
	FROM dbo.THUCDON
	WHERE MALOAI = @V_MALOAI
END;

--Thủ tục thêm món
GO
CREATE PROCEDURE CF_THUCDON_ADD
(
	@V_MAMMON	       VARCHAR(10),
	@V_TENMON		   NVARCHAR(255),
	@V_MALOAI		   VARCHAR(10),
	@V_DVT			   NVARCHAR(10),
	@V_HINHANH		   NVARCHAR(MAX)
)
AS
BEGIN
	INSERT INTO dbo.THUCDON
	VALUES 
		  (@V_MAMMON, 
		  @V_TENMON, 
		  @V_MALOAI, 
		  @V_DVT, 
		  @V_HINHANH)
END;

--Thủ tục sửa món
GO
CREATE PROCEDURE CF_THUCDON_UPD
(
	@V_MAMMON	       VARCHAR(10),
	@V_TENMON		   NVARCHAR(255),
	@V_MALOAI		   VARCHAR(10),
	@V_DVT			   NVARCHAR(10),
	@V_HINHANH		   NVARCHAR(MAX)
)
AS
BEGIN
	UPDATE THUCDON
	SET TENMON = @V_TENMON,
		MALOAI = @V_MALOAI,
		DVT = @V_DVT,
		HINHANH = @V_HINHANH
	WHERE MAMON = @V_MAMMON
END;

--Thủ tục xóa món
GO
CREATE PROCEDURE CF_THUCDON_DEL
(
	@V_MAMMON	       VARCHAR(10)
)
AS
BEGIN
	DELETE THUCDON
	WHERE MAMON = @V_MAMMON
END;
									------------------ Chi Tiết Thực Đơn ---------------------
--Lấy chi tiết thực đơn
GO
CREATE PROCEDURE CF_CTTHUCDON_GET
(
	@V_MACTMON         NVARCHAR(10)
)
AS
BEGIN
	SELECT * 
	FROM dbo.CTTHUCDON
	WHERE MACTMON = @V_MACTMON
END;
--Thủ tục tìm kiếm thực đơn
GO
CREATE PROCEDURE CF_CTTHUCDON_SRH 
(
	@V_KEYWORD         NVARCHAR(MAX),
	@V_SEARCHTYPE      INT --- 1: Tìm theo mã món
)
AS
BEGIN
	SELECT * 
	FROM dbo.THUCDON
	WHERE (@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        (@V_SEARCHTYPE = 1 AND MAMON LIKE '%' + RTRIM(@V_KEYWORD) +'%')
END;

--Lấy chi tiết thực đơn theo món
GO
CREATE PROCEDURE CF_CTTHUCDON_MON 
(
	@V_MAMON         NVARCHAR(10)
)
AS
BEGIN
	SELECT * 
	FROM dbo.CTTHUCDON
	WHERE MAMON = @V_MAMON
END;

--Lấy chi tiết thực đơn theo món va size
GO
CREATE PROCEDURE CF_CTTHUCDON_MS 
(
	@V_MAMON         NVARCHAR(10),
	@V_Size			 VARCHAR(3)
)
AS
BEGIN
	SELECT * 
	FROM dbo.CTTHUCDON
	WHERE MAMON = @V_MAMON AND Size = @V_Size
END;

--Thêm chi tiết thực đơn
GO
CREATE PROCEDURE CF_CTTHUCDON_ADD 
(
	@V_MACTMON       VARCHAR(10),
	@V_Size			 VARCHAR(2),
	@V_GIA			 FLOAT,
	@V_MAMON         VARCHAR(10)
)
AS
BEGIN
	INSERT INTO CTTHUCDON 
	VALUES
		  (@V_MACTMON,
		   @V_Size,
		   @V_GIA,
		   @V_MAMON)
END;
	
--Sửa chi tiết thực đơn
GO
CREATE PROCEDURE CF_CTTHUCDON_UPD 
(
	@V_Size			 VARCHAR(2),
	@V_GIA			 FLOAT,
	@V_MAMON         VARCHAR(10)
)
AS
BEGIN
	UPDATE CTTHUCDON 
	SET GIA = @V_GIA
	WHERE Size = @V_Size AND MAMON = @V_MAMON
END;

--Xóa chi tiết thực đơn
GO
CREATE PROCEDURE CF_CTTHUCDON_DEL 
(
	@V_Size			 VARCHAR(2),
	@V_MAMON         VARCHAR(10)
)
AS
BEGIN
	DELETE CTTHUCDON 
	WHERE Size = @V_Size AND MAMON = @V_MAMON
END;	
									------------------ Hóa Đơn ---------------------
--Thủ tục lấy hóa đơn theo bàn
GO 
CREATE PROCEDURE CF_LAYHOADON_BAN
(
	@V_MABAN	INT
)
AS
BEGIN
	SELECT CT.MACTMON, MON.TENMON, CT.SOLUONG, CTMON.Size, THANHTIEN = CT.SOLUONG * CTMON.GIA, HD.MAKHACHHANG, KH.TENKHACHHANG, MON.MAMON
	FROM dbo.HOADON HD, dbo.CT_HOADON CT, dbo.THUCDON MON, dbo.CTTHUCDON CTMON, dbo.KHACHHANG KH
	WHERE
		 HD.MAHOADON = CT.MAHOADON AND
		 HD.MAKHACHHANG = KH.MAKHACHHANG AND
		 CT.MACTMON = CTMON.MACTMON AND
		 CTMON.MAMON = MON.MAMON AND
		 HD.MABAN = @V_MABAN AND HD.NGAYXUAT is NULL
END;

--Thủ tục lấy danh sách hóa đơn
GO
CREATE PROCEDURE CF_HOADON_GET
AS
BEGIN
	SELECT *
	FROM dbo.HOADON
	ORDER BY MAHOADON DESC
END;

--Thủ tục thêm hóa đơn
GO
CREATE PROCEDURE CF_HOADON_ADD
(
	@V_MAHOADON		VARCHAR(10),
	@V_NGAYLAP		DATETIME,
	@V_TONGTIEN		FLOAT,
	@V_MABAN		INT,
	@V_MANHANVIEN	VARCHAR(10),
	@V_MAKHACHHANG	VARCHAR(10)
)
AS
BEGIN
	INSERT INTO dbo.HOADON (MAHOADON, NGAYLAP, TONGTIEN, MABAN, MANHANVIEN, MAKHACHHANG)
	VALUES 
		  (@V_MAHOADON,
		  @V_NGAYLAP,
		  @V_TONGTIEN, 
		  @V_MABAN, 
		  @V_MANHANVIEN, 
		  @V_MAKHACHHANG)
END;

--Thủ tục cập nhật tổng tiền hóa đơn
GO
CREATE PROCEDURE CF_CAPNHATTONGTIEN_HD
(
	@V_MAHOADON		VARCHAR(10),
	@V_TONGTIEN		FLOAT
)
AS
BEGIN
	UPDATE dbo.HOADON
	SET TONGTIEN = @V_TONGTIEN
	WHERE MAHOADON = @V_MAHOADON
END;

--Thủ tục cập nhật hóa đơn lúc thanh toán
GO
CREATE PROCEDURE CF_HOADON_PAY
(
	@V_MAHOADON		VARCHAR(10),
	@V_NGAYXUAT		DATETIME,
	@V_THANHTOAN	FLOAT,
	@V_MAGIAMGIA	VARCHAR(10)
)
AS
BEGIN
	SET DATEFORMAT DMY

	IF @V_MAGIAMGIA = 'NULL'
		UPDATE HOADON
		SET NGAYXUAT = @V_NGAYXUAT,
			THANHTOAN = @V_THANHTOAN
		WHERE MAHOADON = @V_MAHOADON
	ELSE
		UPDATE HOADON
		SET NGAYXUAT = @V_NGAYXUAT,
			THANHTOAN = @V_THANHTOAN,
			MAGIAMGIA = @V_MAGIAMGIA
		WHERE MAHOADON = @V_MAHOADON
END;

-- Thủ tục lấy thông tin RPHoaDon
GO
CREATE PROCEDURE CF_RPHOADON_GET
(
	@V_MAHOADON		VARCHAR(10)
)
AS
BEGIN
	SELECT *
	FROM RPHOADON
	WHERE MAHOADON = @V_MAHOADON
END;

									------------------ Chi Tiết Hóa Đơn ---------------------
--Thủ tục thêm chi tiết hóa đơn
GO
CREATE PROCEDURE CF_CTHOADON_ADD
(
	@V_MAHOADON		VARCHAR(10),
	@V_MACTMON		VARCHAR(10),
	@V_SOLUONG		INT
)
AS
BEGIN
	INSERT INTO dbo.CT_HOADON (MAHOADON, MACTMON, SOLUONG)
	VALUES 
		  (@V_MAHOADON,
		  @V_MACTMON,
		  @V_SOLUONG)
END;

--Thủ tục lấy chi tiết hóa đơn theo hóa đơn
GO
CREATE PROCEDURE CF_CTHOADON_GET
(
	@V_MAHOADON		VARCHAR(10)
)
AS
BEGIN
	SELECT *
	FROM dbo.CT_HOADON
	WHERE MAHOADON = @V_MAHOADON
END;

--Thủ tục cập nhật chi tiết hóa đơn theo hóa đơn
GO
CREATE PROCEDURE CF_CTHOADON_UPD
(
	@V_MAHOADON		VARCHAR(10),
	@V_MACTMON		VARCHAR(10),
	@V_SOLUONG		INT
)
AS
BEGIN
	UPDATE dbo.CT_HOADON
	SET
		SOLUONG = @V_SOLUONG
	WHERE MAHOADON = @V_MAHOADON AND
		  MACTMON = @V_MACTMON
END;

--Thủ tục xóa chi tiết hóa đơn
GO
CREATE PROCEDURE CF_CTHOADON_DEL
(
	@V_MAHOADON		VARCHAR(10),
	@V_MACTMON		VARCHAR(10)
)
AS
BEGIN
	DELETE CT_HOADON
	WHERE MAHOADON = @V_MAHOADON AND
		  MACTMON = @V_MACTMON
END;


------ Quản lý bàn ----
---- THỦ TỤC TÌM KIẾM BÀN
GO
CREATE PROCEDURE CF_BAN_SRH
(
	@V_SEARCHTYPE	INT, --- 0 LÀ TÌM THEO MÃ BÀN, 1 TÌM THEO TÊN BÀN, -1 LÀ LẤY HẾT TẤT CẢ
	@V_KEYWORD		NVARCHAR(MAX)
)
AS
BEGIN
	SELECT * 
	FROM dbo.BAN
	WHERE (@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND MABAN = @V_KEYWORD)
        OR
        (@V_SEARCHTYPE = 1 AND TENBAN LIKE '%' + RTRIM(@V_KEYWORD) +'%')
END;

------- THỦ TỤC THÊM BÀN
--GO
--CREATE PROCEDURE CF_BAN_ADD
--(
--	@V_TENBAN			NVARCHAR(50),
--	@V_SOCHONGOI		INT,
--	@V_TRANGTHAI		NVARCHAR(MAX),
--	@V_MAKHUVUC			VARCHAR(10)
--)
--AS
--BEGIN
--	INSERT INTO BAN
--	VALUES(@V_TENBAN, @V_SOCHONGOI, @V_TRANGTHAI, @V_MAKHUVUC, 0)
--END;

----- THỦ TỤC Cập nhật bàn
GO
CREATE PROCEDURE CF_BAN_UPD
(
	@V_MABAN			VARCHAR(10),
	@V_TENBAN			NVARCHAR(50),
	@V_SOCHONGOI		INT,
	@V_TRANGTHAI		NVARCHAR(MAX),
	@V_MAKHUVUC			VARCHAR(10)
)
AS
BEGIN
	UPDATE BAN
	SET TENBAN = @V_TENBAN, SOCHONGOI =  @V_SOCHONGOI, TRANGTHAI = @V_TRANGTHAI, MAKHUVUC = @V_MAKHUVUC
	WHERE MABAN = @V_MABAN
END;

----------------- Quản lý Khuyến Mãi---------------
---- THỦ TỤC TÌM KIẾM MÃ GIẢM GIÁ
GO
CREATE PROCEDURE CF_GIAMGIA_LOAD
(
	@V_MAGIAMGIA	VARCHAR(10)
)
AS
BEGIN
	SELECT * 
	FROM dbo.GIAMGIA
	WHERE (@V_MAGIAMGIA = '0' AND TINHTRANG = 0)
        OR
        ( MAGIAMGIA = @V_MAGIAMGIA AND TINHTRANG = 0)        
END;

---- THỦ TỤC THÊM MỚI MÃ GIẢM GIÁ
GO
CREATE PROCEDURE CF_GIAMGIA_ADD
(
	@V_MAGIAMGIA	VARCHAR(10),
	@V_GIAM			INT,
	@V_GIAMTOIDA	VARCHAR(10),
	@V_NGAYBATDAU	DATE,
	@V_NGAYKETTHUC	DATE,
	@V_SOLUOT	    VARCHAR(10)
)
AS
BEGIN
	SET DATEFORMAT DMY
	INSERT INTO GIAMGIA
	VALUES
		  (@V_MAGIAMGIA, @V_GIAM, @V_GIAMTOIDA, @V_NGAYBATDAU, @V_NGAYKETTHUC, @V_SOLUOT, 0)
END;

---- THỦ TỤC CẬP NHẬT MÃ GIẢM GIÁ
GO
CREATE PROCEDURE CF_GIAMGIA_UPD
(
	@V_MAGIAMGIA	VARCHAR(10),
	@V_GIAM			INT,
	@V_GIAMTOIDA	VARCHAR(10),
	@V_NGAYBATDAU	DATE,
	@V_NGAYKETTHUC	DATE,
	@V_SOLUOT	    VARCHAR(10)
)
AS
BEGIN
	SET DATEFORMAT DMY
	UPDATE GIAMGIA
	SET GIAM = @V_GIAM,
		GIAMTOIDA = @V_GIAMTOIDA,
		NGAYBATDAU = @V_NGAYBATDAU,
		NGAYKETTHUC = @V_NGAYKETTHUC,
		SOLUOT = @V_SOLUOT
	WHERE MAGIAMGIA = @V_MAGIAMGIA
END;

---- THỦ TỤC XÓA MÃ GIẢM GIÁ
GO
CREATE PROCEDURE CF_GIAMGIA_DEL
(
	@V_MAGIAMGIA	VARCHAR(10)
)
AS
BEGIN
	UPDATE GIAMGIA
	SET TINHTRANG = 1
	WHERE MAGIAMGIA = @V_MAGIAMGIA
END;


------------------ NGUYÊN LIỆU---------------
---------THỦ THỤC LẤY DANH SÁCH NGUYÊN LIỆU
GO
CREATE PROCEDURE CF_NGUYENLIEU_LOAD
(
	@V_TENNGUYENLIEU	VARCHAR(10)
)
AS
BEGIN
	SELECT NL.MANGUYENLIEU, NL.TENNGUYENLIEU, NL.SOLUONG, NL.DVT, NL.MANHACUNGCAP, NCC.TENNHACUNGCAP, NL.TINHTRANG
	FROM NGUYENLIEU  NL, NHACUNGCAP NCC
	WHERE (@V_TENNGUYENLIEU = '0' AND NL.TINHTRANG = 0 AND NL.MANHACUNGCAP = NCC.MANHACUNGCAP)
        OR
        ( TENNGUYENLIEU LIKE '%' + RTRIM(@V_TENNGUYENLIEU) +'%' AND NL.TINHTRANG = 0 AND NL.MANHACUNGCAP = NCC.MANHACUNGCAP)  
END;

---- THỦ TỤC THÊM MỚI NGUYÊN LIỆU
GO
CREATE PROCEDURE CF_NGUYENLIEU_ADD
(
	@V_TENNGUYENLIEU		NVARCHAR(255),
	@V_SOLUONG			    FLOAT(3),
	@V_DVT					NVARCHAR(10),
	@V_MANHACUNGCAP			INT
)
AS
BEGIN
	INSERT INTO NGUYENLIEU
	VALUES
		  (@V_TENNGUYENLIEU, @V_SOLUONG, @V_DVT, @V_MANHACUNGCAP, 0)
END;
------------------THỦ TỤC CẬP NHẬT NGUYÊN LIỆU
GO
CREATE PROCEDURE CF_NGUYENLIEU_UPD
(
	@V_MANGUYENLIEU			INT,
	@V_TENNGUYENLIEU		NVARCHAR(255),
	@V_SOLUONG			    FLOAT(3),
	@V_DVT					NVARCHAR(10),
	@V_MANHACUNGCAP			INT
)
AS
BEGIN
	UPDATE NGUYENLIEU
	SET TENNGUYENLIEU = @V_TENNGUYENLIEU, SOLUONG = @V_SOLUONG, DVT = @V_DVT, MANHACUNGCAP = @V_MANHACUNGCAP
	WHERE MANGUYENLIEU = @V_MANGUYENLIEU
END;

------------------THỦ TỤC CẬP NHẬT SỐ LƯỢNG NGUYÊN LIỆU
GO
CREATE PROCEDURE CF_NGUYENLIEU_SL
(
	@V_MANGUYENLIEU			INT,
	@V_SOLUONG			    FLOAT(3)
)
AS
BEGIN
	UPDATE NGUYENLIEU
	SET SOLUONG = SOLUONG - @V_SOLUONG
	WHERE MANGUYENLIEU = @V_MANGUYENLIEU
END;
--------------THỦ TỤC XÓA NGUYÊN LIỆU
GO
CREATE PROCEDURE CF_NGUYENLIEU_DEL
(
	@V_MANGUYENLIEU			INT
)
AS
BEGIN
	UPDATE NGUYENLIEU
	SET TINHTRANG = -1
	WHERE MANGUYENLIEU = @V_MANGUYENLIEU
END;

------ ------------- NHÀ CUNG CẤP ----
---- THỦ TỤC TÌM KIẾM NHÀ CUNG CẤP
GO
CREATE PROCEDURE CF_NHACUNGCAP_SRH
(
	@V_SEARCHTYPE	INT, --- 0 LÀ TÌM THEO TÊN NHÀ, 1 TÌM THEO SDT, -1 LẤY TẤT CẢ
	@V_KEYWORD		NVARCHAR(MAX)
)
AS
BEGIN
	SELECT * 
	FROM dbo.NHACUNGCAP
	WHERE (@V_SEARCHTYPE = -1 OR @V_KEYWORD IS NULL AND TINHTRANG = 0)
        OR
        ( @V_SEARCHTYPE = 0 AND TENNHACUNGCAP LIKE '%' + RTRIM(@V_KEYWORD) +'%' AND TINHTRANG = 0)
        OR
        (@V_SEARCHTYPE = 1 AND SDT = @V_KEYWORD AND TINHTRANG = 0)
END;
---- THỦ TỤC THÊM MỚI NHÀ CUNG CẤP
GO
CREATE PROCEDURE CF_NHACUNGCAP_ADD
(
	@V_TENNHACUNGCAP		NVARCHAR(50),
	@V_SDT					FLOAT,
	@V_DIACHI				NVARCHAR(255)
)
AS
BEGIN
	INSERT INTO NHACUNGCAP
	VALUES
		  (@V_TENNHACUNGCAP, @V_SDT, @V_DIACHI, 0)
END;

-------------- // --- CÔNG THỨC
-----------LẤY DANH SÁCH CÔNG THỨC THEO MÓN
GO
CREATE PROCEDURE CF_CONGTHUC_MON
(
	@V_MAMON	VARCHAR(10)
)
AS
BEGIN
	SELECT TD.MAMON, TD.TENMON, CTMON.SIZE, NL.MANGUYENLIEU, NL.TENNGUYENLIEU, CT.MACTMON, CT.HAMLUONG, NL.TINHTRANG
	FROM NGUYENLIEU NL, CONGTHUC CT, THUCDON TD, CTTHUCDON CTMON
	WHERE NL.MANGUYENLIEU = CT.MANGUYENLIEU AND CT.MACTMON = CTMON.MACTMON AND CTMON.MAMON = TD.MAMON AND TD.MAMON = @V_MAMON
	ORDER BY MACTMON
END;
-----------THÊM CÔNG THỨC
GO
CREATE PROCEDURE CF_CONGTHUC_ADD
(
	@V_MACTMON			VARCHAR(10),
	@V_MANGUYENLIEU		INT,
	@V_HAMLUONG			FLOAT(3)
)
AS
BEGIN
	INSERT INTO CONGTHUC
	VALUES
		  (@V_MACTMON, @V_MANGUYENLIEU, @V_HAMLUONG)
END;

-----------SỬA CÔNG THỨC
GO
CREATE PROCEDURE CF_CONGTHUC_UPD
(
	@V_MACTMON			VARCHAR(10),
	@V_MANGUYENLIEU		INT,
	@V_HAMLUONG			FLOAT(3)
)
AS
BEGIN
	UPDATE CONGTHUC
	SET HAMLUONG = @V_HAMLUONG
	WHERE MACTMON = @V_MACTMON AND MANGUYENLIEU =  @V_MANGUYENLIEU
END;
-----------XÓA CÔNG THỨC
GO
CREATE PROCEDURE CF_CONGTHUC_DEL
(
	@V_MACTMON			VARCHAR(10),
	@V_MANGUYENLIEU		INT
)
AS
BEGIN
	DELETE CONGTHUC
	WHERE MACTMON = @V_MACTMON AND MANGUYENLIEU =  @V_MANGUYENLIEU
END;


------------ PHIẾU ĐẶT
---- THÊM PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_PHIEUDAT_ADD
(
	@V_MAPHIEUDAT		VARCHAR(10),
	@V_TENPHIEUDAT		NVARCHAR(255),
	@V_NGAYLAP			DATETIME,
	@V_TONGTIEN			FLOAT,
	@V_MANHANVIEN		VARCHAR(10)
)
AS
BEGIN
	SET DATEFORMAT DMY
	INSERT INTO PHIEUDAT
	VALUES(@V_MAPHIEUDAT, @V_TENPHIEUDAT, GETDATE(), @V_TONGTIEN, 0, @V_MANHANVIEN)
END;
---- CẬP NHẬT PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_PHIEUDAT_UPD
(
	@V_MAPHIEUDAT		VARCHAR(10),
	@V_TENPHIEUDAT		NVARCHAR(255),
	@V_TONGTIEN			FLOAT
)
AS
BEGIN
	UPDATE PHIEUDAT
	SET TENPHIEUDAT = @V_TENPHIEUDAT, TONGTIEN = @V_TONGTIEN
	WHERE MAPHIEUDAT = @V_MAPHIEUDAT
END;

---- XÓA PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_PHIEUDAT_DEL
(
	@V_MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	UPDATE PHIEUDAT
	SET TINHTRANG = -1
	WHERE MAPHIEUDAT = @V_MAPHIEUDAT
END;

---- SEARH PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_PHIEUNHAP_LOAD
AS
BEGIN
	SELECT *
	FROM PHIEUNHAP
END;

GO
CREATE PROCEDURE CF_PHIEUDAT_SRH
(
	@V_SEARCHTYPE		INT, ---1 LẤY TẤT CẢ, 0 - MÃ PHIẾU ĐẶT, 1 NÔI DỤNG
	@V_KEYWORD			NVARCHAR(250),
	@V_STARTDAY			DATE,
	@V_ENDDATE			DATE,
	@V_NCC				INT
)
AS
BEGIN
	SET DATEFORMAT DMY
	SELECT TOP 50 PD.MAPHIEUDAT, PD.TENPHIEUDAT, PD.NGAYLAP, PD.TONGTIEN, PD.TINHTRANG, PD.MANHANVIEN, NV.HOTEN
	FROM PHIEUDAT PD, NHANVIEN NV, CT_PHIEUDAT CT, NGUYENLIEU NL
	WHERE
		PD.MANHANVIEN = NV.MANHANVIEN AND
		PD.MAPHIEUDAT = CT.MAPHIEUDAT AND
		CT.MANGUYENLIEU = NL.MANGUYENLIEU AND
		PD.TINHTRANG > -1 AND
		(
		(@V_SEARCHTYPE = -1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' AND @V_NCC = 0 OR @V_KEYWORD IS NULL)
        OR
		(@V_SEARCHTYPE = -1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' AND NL.MANHACUNGCAP = @V_NCC OR @V_KEYWORD IS NULL)
        OR
        ( @V_SEARCHTYPE = 0 AND PD.MAPHIEUDAT = @V_KEYWORD AND PD.TINHTRANG > -1)
        OR
        (@V_SEARCHTYPE = 1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' AND @V_NCC = 0 AND TENPHIEUDAT LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		OR
        (@V_SEARCHTYPE = 1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' AND NL.MANHACUNGCAP = @V_NCC AND TENPHIEUDAT LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		OR
        (@V_SEARCHTYPE = -1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1) AND @V_NCC = 0)
		OR
        (@V_SEARCHTYPE = -1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1) AND NL.MANHACUNGCAP = @V_NCC)
		OR
        (@V_SEARCHTYPE = 1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1) AND TENPHIEUDAT LIKE '%' + RTRIM(@V_KEYWORD) +'%' AND @V_NCC = 0)
		OR
        (@V_SEARCHTYPE = 1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1)  AND NL.MANHACUNGCAP = @V_NCC AND TENPHIEUDAT LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		OR
        (@V_SEARCHTYPE = -1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1) AND NL.MANHACUNGCAP = @V_NCC)
		OR
        (@V_SEARCHTYPE = -1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYLAP) > -1) AND (DATEDIFF(DAY , NGAYLAP, @V_ENDDATE) > -1) AND @V_NCC = 0)
		)
	GROUP BY PD.MAPHIEUDAT, PD.TENPHIEUDAT, PD.NGAYLAP, PD.TONGTIEN, PD.TINHTRANG, PD.MANHANVIEN, NV.HOTEN
END;
---- Lấy danh sách PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_PHIEUDAT_LOAD
AS
BEGIN
	SELECT *
	FROM PHIEUDAT
END;
---- LẤY DS PHIẾU ĐẶT THEO NCC
GO
CREATE PROCEDURE CF_PHIEUDAT_NCC
(
	@V_MANCC		INT
)
AS
BEGIN
	SELECT PD.MAPHIEUDAT, PD.TENPHIEUDAT, PD.NGAYLAP, PD.TONGTIEN, PD.TINHTRANG, PD.MANHANVIEN, NV.HOTEN
	FROM PHIEUDAT PD, NHANVIEN NV, CT_PHIEUDAT CT, NGUYENLIEU NL
	WHERE
		PD.MANHANVIEN = NV.MANHANVIEN AND
		PD.MAPHIEUDAT = CT.MAPHIEUDAT AND
		CT.MANGUYENLIEU = NL.MANGUYENLIEU AND
		NL.MANHACUNGCAP = @V_MANCC AND PD.TINHTRANG > -1
	GROUP BY PD.MAPHIEUDAT, PD.TENPHIEUDAT, PD.NGAYLAP, PD.TONGTIEN, PD.TINHTRANG, PD.MANHANVIEN, NV.HOTEN
END;

--------- CHI TIẾT PHIẾU ĐẶT
--- THÊM CHI TIẾT PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_CTPHIEUDAT_ADD
(
	@V_MANGUYENLIEU		INT,
	@V_MAPHIEUDAT		VARCHAR(10),
	@V_SOLUONG			FLOAT(3),
	@V_GIADAT		INT
)
AS
BEGIN
	INSERT INTO CT_PHIEUDAT
	VALUES(@V_MANGUYENLIEU, @V_MAPHIEUDAT, @V_SOLUONG, @V_GIADAT)
END;

---- LẤY CHI TIẾT PHIẾU ĐẶT THEO MÃ PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_CTPHIEUDAT_LOAD
(
	@V_MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	SELECT CT.MANGUYENLIEU, NL.TENNGUYENLIEU, CT.SOLUONG, CT.GIADAT, THANHTIEN = CT.SOLUONG * CT.GIADAT, NHACUNGCAP = CONCAT(NCC.MANHACUNGCAP, ' - ', NCC.TENNHACUNGCAP)
	FROM CT_PHIEUDAT CT, NGUYENLIEU NL, NHACUNGCAP NCC
	WHERE MAPHIEUDAT = @V_MAPHIEUDAT AND CT.MANGUYENLIEU = NL.MANGUYENLIEU AND NL.MANHACUNGCAP = NCC.MANHACUNGCAP
END;

---- XÓA CHI TIẾT PHIẾU ĐẶT
GO
CREATE PROCEDURE CF_CTPHIEUDAT_DEL
(
	@V_MANGUYENLIEU		INT,
	@V_MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	DELETE CT_PHIEUDAT
	WHERE MANGUYENLIEU = @V_MANGUYENLIEU AND MAPHIEUDAT = @V_MAPHIEUDAT
END;

------ LOAD NGUYÊN LIỆU ĐÃ NHẬP
GO
CREATE PROCEDURE CF_CTPHIEUDAT_NHAP
(
	@V_MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	SELECT CTDAT.MANGUYENLIEU, NL.TENNGUYENLIEU, CTDAT.SOLUONG, SUM(CTNHAP.SOLUONG) AS SLNHAP
	FROM PHIEUDAT PD, CT_PHIEUDAT CTDAT, CT_PHIEUNHAP CTNHAP, NGUYENLIEU NL
	WHERE PD.MAPHIEUDAT = CTDAT.MAPHIEUDAT AND
		  CTDAT.MANGUYENLIEU = NL.MANGUYENLIEU AND
		  CTDAT.MANGUYENLIEU = CTNHAP.MANGUYENLIEU AND
		   PD.MAPHIEUDAT = @V_MAPHIEUDAT
	GROUP BY CTDAT.MANGUYENLIEU, NL.TENNGUYENLIEU, CTDAT.SOLUONG
END;

------ LOAD NGUYÊN LIỆU CHƯA NHẬP
GO
CREATE PROCEDURE CF_CTPHIEUDAT_CNHAP
(
	@V_MAPHIEUDAT		VARCHAR(10)
)
AS
BEGIN
	SELECT CTDAT.MANGUYENLIEU, NL.TENNGUYENLIEU, CTDAT.SOLUONG, 0 AS SLNHAP
	FROM PHIEUDAT PD, CT_PHIEUDAT CTDAT, NGUYENLIEU NL
	WHERE PD.MAPHIEUDAT = CTDAT.MAPHIEUDAT AND
		  CTDAT.MANGUYENLIEU = NL.MANGUYENLIEU AND PD.MAPHIEUDAT = @V_MAPHIEUDAT
	GROUP BY CTDAT.MANGUYENLIEU, NL.TENNGUYENLIEU, CTDAT.SOLUONG
END;


----------- PHIẾU NHẬP
---- THÊM PHIẾU NHẬP


GO
CREATE PROCEDURE CF_PHIEUNHAP_ADD
(
	@V_MAPHIEUNHAP		VARCHAR(10),
	@V_MAPHIEUDAT		VARCHAR(10),
	@V_NGAYLAP			DATETIME,
	@V_NOIDUNG			NVARCHAR(250),
	@V_MANHANVIEN		VARCHAR(10)
)
AS
BEGIN
	INSERT INTO PHIEUNHAP
	VALUES(@V_MAPHIEUNHAP, @V_MAPHIEUDAT, @V_NGAYLAP, @V_NOIDUNG, @V_MANHANVIEN, 0)
END;
---- SỬA PHIẾU NHẬP
GO
CREATE PROCEDURE CF_PHIEUNHAP_UPD
(
	@V_MAPHIEUNHAP		VARCHAR(10),
	@V_NOIDUNG			NVARCHAR(250)
)
AS
BEGIN
	UPDATE PHIEUNHAP
	SET NOIDUNG = @V_NOIDUNG
	WHERE MAPHIEUNHAP = @V_MAPHIEUNHAP
END;
---- XÓA PHIẾU NHẬP
GO
CREATE PROCEDURE CF_PHIEUNHAP_DEL
(
	@V_MAPHIEUNHAP		VARCHAR(10)
)
AS
BEGIN
	UPDATE PHIEUNHAP
	SET TINHTRANG = -1
	WHERE MAPHIEUNHAP = @V_MAPHIEUNHAP
END;

--------- TÌM KIẾM PHIẾU NHẬP
GO
CREATE PROCEDURE CF_PHIEUNHAP_SRH
(
	@V_SEARCHTYPE		INT, ---1 LẤY TẤT CẢ, 0 - MÃ PHIẾU ĐẶT, 1 NÔI DỤNG
	@V_KEYWORD			NVARCHAR(250),
	@V_STARTDAY			DATE,
	@V_ENDDATE			DATE
)
AS
BEGIN
	SELECT TOP 50 PN.MAPHIEUNHAP, PN.NOIDUNG, PN.NGAYNHAP, NHANVIEN = CONCAT(PN.MANHANVIEN, ' - ', NV.HOTEN), PN.MAPHIEUDAT
	FROM PHIEUNHAP PN, NHANVIEN NV
	WHERE
		PN.MANHANVIEN = NV.MANHANVIEN AND
		PN.TINHTRANG > -1 AND
		(
		(@V_SEARCHTYPE = -1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' OR @V_KEYWORD IS NULL)
        OR
		( @V_SEARCHTYPE = 0 AND PN.MAPHIEUNHAP = @V_KEYWORD)
		OR
		(@V_SEARCHTYPE = 1 AND @V_STARTDAY = '01/01/0001' AND @V_ENDDATE = '01/01/0001' AND NOIDUNG LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		OR
        (@V_SEARCHTYPE = -1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYNHAP) > -1) AND (DATEDIFF(DAY , NGAYNHAP, @V_ENDDATE) > -1))
		OR
        (@V_SEARCHTYPE = 1 AND (DATEDIFF(DAY , @V_STARTDAY, NGAYNHAP) > -1) AND (DATEDIFF(DAY , NGAYNHAP, @V_ENDDATE) > -1) AND NOIDUNG LIKE '%' + RTRIM(@V_KEYWORD) +'%')
		)
END;

----------- CHI TIẾT PHIẾU NHẬP
---- LOAD CHI TIẾT
GO
CREATE PROCEDURE CF_CTPHIEUNHAP_LOAD
(
	@V_MAPHIEUNHAP		VARCHAR(10)
)
AS
BEGIN
	SELECT NL.MANGUYENLIEU, NL.TENNGUYENLIEU, CT.SOLUONG, CT.MAPHIEUNHAP
	FROM CT_PHIEUNHAP CT, NGUYENLIEU NL
	WHERE
		 CT.MANGUYENLIEU = NL.MANGUYENLIEU AND
		 MAPHIEUNHAP = @V_MAPHIEUNHAP
END;
---- THÊM CHI TIẾT
GO
CREATE PROCEDURE CF_CTPHIEUNHAP_ADD
(
	@V_MANGUYENLIEU		INT,
	@V_MAPHIEUNHAP		VARCHAR(10),
	@V_SOLUONG			FLOAT(3)
)
AS
BEGIN
	INSERT INTO CT_PHIEUNHAP
	VALUES(@V_MANGUYENLIEU, @V_MAPHIEUNHAP, @V_SOLUONG)
END;
--- XÓA CHI TIẾT
GO
CREATE PROCEDURE CF_CTPHIEUNHAP_DEL
(
	@V_MAPHIEUNHAP		VARCHAR(10),
	@V_MANGUYENLIEU		INT
)
AS
BEGIN
	DELETE CT_PHIEUNHAP
	WHERE MAPHIEUNHAP = @V_MAPHIEUNHAP AND MANGUYENLIEU = @V_MANGUYENLIEU
END;



---------------------------------BÀN----------------------------------------
GO
CREATE PROCEDURE CF_BAN_ADD
(
	@V_TENBAN			NVARCHAR(50),
	@V_SOCHONGOI		INT,
	@V_TRANGTHAI		NVARCHAR(MAX),
	@V_MAKHUVUC			VARCHAR(10)
	
)
AS
BEGIN
	INSERT INTO dbo.BAN
	VALUES 
		  (@V_TENBAN,
		  @V_SOCHONGOI,
		  @V_TRANGTHAI,
		  @V_MAKHUVUC,
		  0)
END;
--UPDATE
GO
CREATE PROCEDURE CF_BAN_UPDATE
(	
	@V_MABAN			INT,
	@V_TENBAN			NVARCHAR(50),
	@V_SOCHONGOI		INT,
	@V_TRANGTHAI		NVARCHAR(MAX),
	@V_MAKHUVUC			VARCHAR(10)
	
)
AS
BEGIN
	UPDATE dbo.BAN
	SET TENBAN = @V_TENBAN, SOCHONGOI = @V_SOCHONGOI, TRANGTHAI = @V_TRANGTHAI,MAKHUVUC = @V_MAKHUVUC
	WHERE MABAN = @V_MABAN
END;
--Xóa bàn
GO
CREATE PROCEDURE CF_BAN_DEL
(
	@V_MABAN      INT
)
AS
BEGIN
	DELETE 
	FROM dbo.BAN
	WHERE MABAN = @V_MABAN
END;


-----Lấy ds bàn
GO
CREATE PROCEDURE CF_BAN_SELECT
AS
BEGIN
	SELECT * 
	FROM dbo.BAN
END;
-------------
----------------------------------------------------------KHU VUC --------------------------------
GO
CREATE PROCEDURE CF_KHUVUC_SELECT
AS
BEGIN
	SELECT * 
	FROM dbo.KHUVUC
END;
GO
CREATE PROCEDURE CF_KHUVUC_ADD
(
	@V_MAKHUVUC			VARCHAR(10),
	@V_TENKHUVUC		nvarchar(50)
	
)
AS
BEGIN
	INSERT INTO dbo.KHUVUC
	VALUES 
		  (
		  @V_MAKHUVUC,
		  @V_TENKHUVUC,
		  0)
END;
--UPDATE
GO
CREATE PROCEDURE CF_KHUVUC_UPDATE
(	
	@V_MAKHUVUC			VARCHAR(10),
	@V_TENKHUVUC		nvarchar(50)
	
)
AS
BEGIN
	UPDATE dbo.KHUVUC
	SET TENKHUVUC = @V_TENKHUVUC 
	WHERE MAKHUVUC = @V_MAKHUVUC
END;
--Xóa khu vực
GO
CREATE PROCEDURE CF_KHUVUC_DEL
(
	@V_MAKHUVUC			VARCHAR(10)
)
AS
BEGIN
	DELETE dbo.KHUVUC
	WHERE MAKHUVUC = @V_MAKHUVUC
END;


--------------Kiểm tra khóa chính--------------
GO
CREATE PROCEDURE CF_BAN_KHOACHINH
(
	@V_MABAN      INT
)
AS
BEGIN
	SELECT COUNT(*) 
	FROM dbo.BAN
	WHERE MABAN = @V_MABAN
END;

GO
CREATE PROC CF_KHUVUC_KHOACHINH
(
	@V_MAKHUVUC      VARCHAR(10)
)
AS
BEGIN
	SELECT COUNT(*) 
	FROM dbo.KHUVUC
	WHERE MAKHUVUC = @V_MAKHUVUC
END;

-----------------------------------------------Tính lương nhân viên-------------------------------------

--------------------------------------------------------------LƯƠNG NHÂN VIÊN-------------------------------------------------------------
-------------------------Trigger-----------------------------
--------------------------------------------------------------LƯƠNG NHÂN VIÊN-------------------------------------------------------------



go
create trigger updateCTTienNV
on CTBANGLUONGNV
for insert
as
update CTBANGLUONGNV
set THANHTIEN = SOTIEN * SOTIENG
where MANHANVIEN=(select MANHANVIEN from inserted)


go
create trigger updateLuongNV
on CTBANGLUONGNV
for insert
as
update LUONGNV
set Luong =(select sum(THANHTIEN) from CTBANGLUONGNV where MABANGLUONG=(select MABANGLUONG from inserted) and MANHANVIEN=(select MANHANVIEN from inserted))
where MABANGLUONG = (select MABANGLUONG from inserted) and MANHANVIEN = (select MANHANVIEN from inserted)

go
create trigger deleteLuongNV
on CTBANGLUONGNV
for delete
as
update LUONGNV
set Luong =(select sum(THANHTIEN) from CTBANGLUONGNV where MABANGLUONG=(select MABANGLUONG from deleted) and MANHANVIEN=(select MANHANVIEN from deleted))
where MABANGLUONG = (select MABANGLUONG from deleted) and MANHANVIEN = (select MANHANVIEN from deleted)

----------------------------------------------------------LUONG QUẢN LÝ -------------------------------------------------
--------------------------------------Đếm số ngày công thực tế--------------------------------------------------
go
create trigger updateCTLuongQL
on CTCHAMCONG_QUANLY
for insert
as
update CTBANGLUONGQL
set NGAYCONGTHUCTE =(select Count(MACA) from CTCHAMCONG_QUANLY where MABANGLUONG=(select MABANGLUONG from inserted) and MANHANVIEN=(select MANHANVIEN from inserted) and MACA=(select MACA from inserted))
where MABANGLUONG = (select MABANGLUONG from inserted) and MANHANVIEN = (select MANHANVIEN from inserted) and MACA = (select MACA from inserted)


go
create trigger deleteCTLuongQL
on CTCHAMCONG_QUANLY
for delete
as
update CTBANGLUONGQL
set NGAYCONGTHUCTE =(select Count(MACA) from CTCHAMCONG_QUANLY where MABANGLUONG=(select MABANGLUONG from deleted) and MANHANVIEN=(select MANHANVIEN from deleted) and MACA=(select MACA from deleted))
where MABANGLUONG = (select MABANGLUONG from deleted) and MANHANVIEN = (select MANHANVIEN from deleted) and MACA = (select MACA from deleted)


---Tính lương QL: Thành tiền = (Lương cơ bản/số ngày công tháng)* số ngày công thực tế + phụ cấp ------------------------------------------------------------
go
create trigger updateCTTienQL
on CTBANGLUONGQL
for update
as
update CTBANGLUONGQL
set THANHTIEN = ((LUONGCOBAN / NGAYCONGTHANG) * NGAYCONGTHUCTE) + ( HESOLUONG * LUONGCOBAN) + PHUCAP
where MANHANVIEN=(select MANHANVIEN from inserted)
----------------------------------------Update Lương QL--------------------------------------------------------------------------
go
create trigger updateLuongQL
on CTBANGLUONGQL
for update
as
update LUONGQL
set Luong =(select sum(THANHTIEN) from CTBANGLUONGQL where MABANGLUONG=(select MABANGLUONG from inserted) and MANHANVIEN=(select MANHANVIEN from inserted))
where MABANGLUONG = (select MABANGLUONG from inserted) and MANHANVIEN = (select MANHANVIEN from inserted)


go
create trigger deleteLuongQL
on CTBANGLUONGQL
for delete
as
update LUONGQL
set Luong =(select sum(THANHTIEN) from CTBANGLUONGQL where MABANGLUONG=(select MABANGLUONG from deleted) and MANHANVIEN=(select MANHANVIEN from deleted))
where MABANGLUONG = (select MABANGLUONG from deleted) and MANHANVIEN = (select MANHANVIEN from deleted)


-------------------------------------------------------------Đặt Bàn NHỰT-------------------------------------------------------

									------------------      Nhựt      ---------------------
									------------------     Đặt Bàn    ---------------------
--Thủ tục thêm đặt bàn
GO
CREATE PROCEDURE CF_DATBAN_ADD
(
	@V_MADATBAN				VARCHAR(10),
	@V_THOIGIANNHANBAN		DATETIME,
	@V_GHICHU				NVARCHAR(250),
	@V_MAKHACHHANG			VARCHAR(10),
	@V_MABAN				INT
)
AS
BEGIN
	INSERT INTO dbo.DATBAN (MADATBAN, THOIGIANNHANBAN, GHICHU, MAKHACHHANG, MABAN)
	VALUES 
		  (@V_MADATBAN,
		  @V_THOIGIANNHANBAN,
		  @V_GHICHU, 
		  @V_MAKHACHHANG, 
		  @V_MABAN)
END;

--Thủ tục lấy danh sách đặt bàn
GO
CREATE PROCEDURE CF_DATBAN_GET
AS
BEGIN
	SELECT *
	FROM dbo.DATBAN
	ORDER BY MADATBAN DESC
END;


--Thủ tục cập nhật tình trạng đặt bàn
GO
CREATE PROCEDURE CF_CAPNHATTINHTRANGDATBAN
(
	@V_MABAN		INT,
	@V_TRANGTHAI	NVARCHAR(MAX)
)
AS
BEGIN
	UPDATE dbo.DATBAN
	SET GHICHU = @V_TRANGTHAI
	WHERE MABAN = @V_MABAN
END;


--Thủ tục lấy thông tin đặt bàn theo bàn
GO 
CREATE PROCEDURE CF_LAYTTKHACHHANG_DATBAN
(
	@V_MABAN	INT
)
AS
BEGIN
	SELECT KH.MAKHACHHANG, KH.TENKHACHHANG
	FROM dbo.KHACHHANG KH, dbo.DATBAN DB, dbo.BAN B
	WHERE
		 B.MABAN = @V_MABAN AND
		 DB.GHICHU = N'Đã đặt' AND
		 KH.MAKHACHHANG = DB.MAKHACHHANG
END;

--Thủ tục XÓA thông tin đặt bàn
GO
CREATE PROCEDURE CF_DATBAN_DEL
(
	@MADATBAN		VARCHAR(10)
)
AS
BEGIN
	UPDATE dbo.DATBAN
	SET GHICHU = N'Đã hủy'
	WHERE MADATBAN = @MADATBAN;
END;
									------------------ Thống Kê Doanh Thu ---------------------

--Thủ tục lấy danh sách hóa đơn
GO
CREATE PROCEDURE CF_HOADON_TKDT_GET
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON
    ORDER BY 
        MAHOADON DESC;
END;

--Thủ tục lấy danh sách hóa đơn theo năm
GO
CREATE PROCEDURE CF_HOADON_TKDT_THEONAM_GET 
(
	@nam	DATE
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT)
    ORDER BY 
        MAHOADON DESC;	
END;

--Thủ tục lấy danh sách hóa đơn theo tháng
GO
CREATE PROCEDURE CF_HOADON_TKDT_THEOTHANG_GET 
(
	@nam	DATE,
	@thang  INT
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT) AND
		@thang LIKE CONVERT(INT, MONTH(HD.NGAYXUAT))
    ORDER BY 
        MAHOADON DESC;
END;

--Thủ tục lấy danh sách hóa đơn theo ngày
GO
CREATE PROCEDURE CF_HOADON_TKDT_THEONGAY_GET 
(
	@ngay	DATE
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		@ngay LIKE CAST(HD.NGAYXUAT AS DATE) 
		
    ORDER BY 
        MAHOADON DESC;
END;

--Thủ tục lấy danh sách hóa đơn theo ngày của nhân viên
GO
CREATE PROCEDURE CF_HOADON_TKDT_NV_THEONGAY_GET 
(
	@MANV VARCHAR(10),
	@ngay	DATE
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		@ngay LIKE CAST(HD.NGAYXUAT AS DATE) AND HD.MANHANVIEN = @MANV
		
    ORDER BY 
        MAHOADON DESC;
END;

--EXEC CF_HOADON_TKDT_NV_THEONGAY_GET 'NV003','2021-11-27';

--Thủ tục lấy danh sách hóa đơn theo năm của nhân viên
GO
CREATE PROCEDURE CF_HOADON_TKDT_NV_THEONAM_GET 
(
	@MANV VARCHAR(10),
	@nam	DATE
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT) AND HD.MANHANVIEN = @MANV
    ORDER BY 
        MAHOADON DESC;	
END;

--Thủ tục lấy danh sách hóa đơn theo tháng
GO
CREATE PROCEDURE CF_HOADON_TKDT_NV_THEOTHANG_GET 
(
	@MANV	VARCHAR(10),
	@nam	DATE,
	@thang  INT
)
AS
BEGIN
    SELECT 
        MAHOADON, 
        NGAYLAP,
		NGAYXUAT,
		TONGTIEN,
		THANHTOAN,
		MABAN,
		MAKHACHHANG,
		MAGIAMGIA
    FROM 
        dbo.HOADON HD
	WHERE
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT) AND
		@thang LIKE CONVERT(INT, MONTH(HD.NGAYXUAT)) AND
		HD.MANHANVIEN = @MANV
    ORDER BY 
        MAHOADON DESC;
END;


									------------------ Thống Kê Doanh Thu ---------------------

 --Thủ tục lấy danh sách mặt hàng bán chạy theo tháng

GO
CREATE PROCEDURE CF_CTHOADON_TKMH_GET
(
	@nam	DATE,
	@thang  INT
)
AS
BEGIN
    SELECT
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) AS N'Mã món',
		TENMON AS N'Tên món',
		DVT AS N'DVT',
		MALOAI AS N'Mã loại',
		COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) AS N'Số lượng'
    FROM 
        dbo.CT_HOADON CTHD, dbo.THUCDON TD, dbo.HOADON HD
	WHERE
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) = TD.MAMON AND
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT) AND
		@thang LIKE CONVERT(INT, MONTH(HD.NGAYXUAT))
	GROUP BY SUBSTRING(MACTMON, 1, LEN(MACTMON)-2), TENMON, DVT, MALOAI
    ORDER BY 
        COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) DESC;
END;

 --Thủ tục lấy danh sách mặt hàng bán chạy theo năm
GO
CREATE PROCEDURE CF_CTHOADON_TKMHTHEONAM_GET
(
	@nam	DATE
)
AS
BEGIN
    SELECT
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) AS N'Mã món',
		TENMON AS N'Tên món',
		DVT AS N'DVT',
		MALOAI AS N'Mã loại',
		COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) AS N'Số lượng'
    FROM 
        dbo.CT_HOADON CTHD, dbo.THUCDON TD, dbo.HOADON HD
	WHERE
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) = TD.MAMON AND
		YEAR(@nam) LIKE YEAR(HD.NGAYXUAT)
	GROUP BY SUBSTRING(MACTMON, 1, LEN(MACTMON)-2), TENMON, DVT, MALOAI
    ORDER BY 
        COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) DESC;
END;


									------------------ Chuyển Bàn ---------------------

 --Thủ tục lấy danh sách mặt hàng bán chạy theo ngày
GO
CREATE PROCEDURE CF_CTHOADON_TKMHTHEONGAY_GET
(
	@ngay	DATE
)
AS
BEGIN
    SELECT
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) AS N'Mã món',
		TENMON AS N'Tên món',
		DVT AS N'DVT',
		MALOAI AS N'Mã loại',
		COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) AS N'Số lượng'
    FROM 
        dbo.CT_HOADON CTHD, dbo.THUCDON TD, dbo.HOADON HD
	WHERE
		SUBSTRING(MACTMON, 1, LEN(MACTMON)-2) = TD.MAMON AND
		@ngay LIKE CAST(HD.NGAYXUAT AS DATE)
	GROUP BY SUBSTRING(MACTMON, 1, LEN(MACTMON)-2), TENMON, DVT, MALOAI
    ORDER BY 
        COUNT(SUBSTRING(MACTMON, 1, LEN(MACTMON)-2)) DESC;
END;


--Thủ tục cập nhật tình trạng chuyển bàn
GO
CREATE PROCEDURE CF_CAPNHATCHUYENBAN
(
	@MABAN			INT,
	@MABANCHUYEN	INT,
	@MAHOADON		VARCHAR(10)
)
AS
BEGIN
	UPDATE dbo.BAN 
	SET TRANGTHAI = N'Trống'
	WHERE MABAN = @MABAN

	UPDATE dbo.BAN 
	SET TRANGTHAI = N'Có Khách'
	WHERE MABAN = @MABANCHUYEN

	UPDATE dbo.HOADON
	SET MABAN = @MABANCHUYEN
	WHERE MAHOADON = @MAHOADON
END;

--Thủ tục kiểm tra trang thái bàn
GO
CREATE PROCEDURE CF_KIEMTRATINHTRANGBAN
(
	@MABAN	INT
)
AS
BEGIN
	SELECT * 
	FROM dbo.BAN
	WHERE MABAN = @MABAN
END;	

									------------------ Gộp Bàn ---------------------

--Thủ tục cập nhật gộp bàn
GO
CREATE PROCEDURE CF_CAPNHATGOPBAN
(
	@MABAN			INT,
	@MABANCHUYEN	INT,
	@MAHOADON		VARCHAR(10),
	@MAHOADONCHUYEN		VARCHAR(10)
)
AS
BEGIN
	DECLARE @TONGTIEN INT;
	SET @TONGTIEN = ( SELECT TONGTIEN
					FROM dbo.HOADON
					WHERE MAHOADON = @MAHOADON );

	UPDATE dbo.HOADON 
	SET TONGTIEN = TONGTIEN + @TONGTIEN
	WHERE MAHOADON = @MAHOADONCHUYEN

	UPDATE dbo.HOADON 
	SET NGAYXUAT = GETDATE(),
		TONGTIEN = NULL
	WHERE MAHOADON = @MAHOADON

	UPDATE dbo.BAN 
	SET TRANGTHAI = N'Trống'
	WHERE MABAN = @MABAN

	--Khai báo biến @... để lưu nội dung đọc
	DECLARE @MAHD varchar(10)
	DECLARE @MACTM varchar(10)
	DECLARE @SOLUONG INT


	DECLARE cursorCT_HOADON CURSOR FOR  -- khai báo con trỏ cursorProduct
	SELECT MAHOADON, MACTMON, SOLUONG 
	FROM dbo.CT_HOADON					-- dữ liệu trỏ tới

	OPEN cursorCT_HOADON                -- Mở con trỏ

	FETCH NEXT FROM cursorCT_HOADON     -- Đọc dòng đầu tiên
		  INTO @MAHD, @MACTM, @SOLUONG

	WHILE @@FETCH_STATUS = 0			--vòng lặp WHILE khi đọc Cursor thành công
	BEGIN
		DECLARE @MACTM_HD varchar(10)

		IF  @MAHD = @MAHOADON --HD002
		BEGIN
			
			UPDATE dbo.CT_HOADON
			SET SOLUONG = SOLUONG + @SOLUONG,
				@MACTM_HD = @MACTM
			WHERE MACTMON = @MACTM AND MAHOADON = @MAHOADONCHUYEN
				
			DELETE FROM dbo.CT_HOADON WHERE  MACTMON = @MACTM_HD AND MAHOADON = @MAHOADON
		END
			
		FETCH NEXT FROM cursorCT_HOADON -- Đọc dòng tiếp
			  INTO @MAHD, @MACTM, @SOLUONG
	END

	CLOSE cursorCT_HOADON              -- Đóng Cursor
	DEALLOCATE cursorCT_HOADON         -- Giải phóng tài nguyên

	UPDATE dbo.CT_HOADON
	SET MAHOADON = @MAHOADONCHUYEN --DH001
	WHERE MAHOADON = @MAHOADON;--DH002
END;


